<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="apple-touch-icon" href="https://files.oaiusercontent.com/file-B29eSrtP87rXkX4U2oK12Y?se=2026-02-16T17%3A19%3A46Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D604800%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3D0f39385b-6f85-4841-8f55-7ca548545e12.webp&sig=qEovqY53L/8eK7V7V4mN2/XG3jL3o9m3V9eE8uK4V4M%3D">

    <title>SparkPlay</title>
    <style>
        :root {
            --bg: #070B14; --accent: #3F5EF6; --gold: #FFB300; --ink: #EAF2FF;
            --magic: #8E44AD; --detective: #2C3E50;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%; margin: 0; overflow: hidden;
            background: var(--bg); font-family: -apple-system, system-ui, sans-serif;
            color: var(--ink);
        }

        #SPARKPLAY_APP { height: 100vh; display: flex; flex-direction: column; transition: background 0.5s ease; }

        /* THEME MODES */
        .theme-spazio { background: radial-gradient(circle at top, #16213E 0%, #070B14 100%); }
        .theme-magia { background: radial-gradient(circle at top, #4A235A 0%, #070B14 100%); }
        .theme-detective { background: radial-gradient(circle at top, #1B2631 0%, #070B14 100%); }

        .header {
            padding: env(safe-area-inset-top) 20px 15px;
            display:flex; justify-content:space-between; align-items:center;
        }

        .stage {
            flex: 1;
            display:flex;
            justify-content:center;
            align-items:center;
            padding: 0 18px 30px;
        }

        .card-game {
            width: 100%;
            max-width: 420px;
            border-radius: 24px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            padding: 22px;
        }

        .world-selector {
            display:flex; gap:10px; justify-content:center; margin-bottom:14px;
        }
        .badge-world {
            padding:10px 12px;
            border-radius: 999px;
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.12);
            opacity: 0.7;
            cursor:pointer;
            user-select:none;
        }
        .badge-world.active {
            opacity: 1;
            background: rgba(255,255,255,0.10);
            border-color: rgba(255,255,255,0.25);
        }

        .instruction {
            font-size: 18px;
            line-height: 1.35;
            font-weight: 700;
            text-align:center;
            margin: 10px 0 18px;
        }

        .btn-main {
            width:100%;
            border:0;
            border-radius: 18px;
            padding: 16px 14px;
            font-weight: 900;
            letter-spacing: 1px;
            font-size: 14px;
            cursor:pointer;
            color: white;
            background: var(--accent);
        }

        .btn-spazio { background: var(--accent); }
        .btn-magia { background: var(--magic); }
        .btn-detective { background: var(--detective); }

        .special-locked {
            margin-top: 14px;
            text-align:center;
            opacity:0.7;
            font-size: 12px;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>
    <div id="SPARKPLAY_APP" class="theme-spazio"></div>

    <script>
        (() => {
            const KEY = "SPARKPLAY_V1_STATE";
            const DEFAULT = { world: "spazio", audio: true, fsm: "HOME", step: 0, count: 0, specialReady: false };

            const Narrator = {
                enabled: true,
                speak(text) {
                    try{
                        if(!this.enabled) return;
                        speechSynthesis.cancel();
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = "it-IT";
                        u.rate = 1.05;
                        speechSynthesis.speak(u);
                    }catch(e){}
                }
            };

            const App = {
                missions: {
                    spazio: [
                        "1) Esplora: trova 3 oggetti che sembrano tecnologia spaziale.",
                        "2) Crea: costruisci una mini base sul tavolo con gli oggetti.",
                        "3) Calma: respira lentamente e racconta la missione fatta."
                    ],
                    magia: [
                        "1) Esplora: trova 3 oggetti che potrebbero essere magici.",
                        "2) Crea: inventa un incantesimo e un rituale con quegli oggetti.",
                        "3) Calma: chiudi gli occhi e descrivi il potere preferito."
                    ],
                    detective: [
                        "1) Esplora: osserva 3 dettagli nella stanza come un detective.",
                        "2) Crea: costruisci una pista usando 2 oggetti come indizi.",
                        "3) Calma: racconta il caso risolto con una voce lenta e calma."
                    ]
                },

                init(){
                    this.s = Object.assign({}, DEFAULT, JSON.parse(localStorage.getItem(KEY) || "null") || {});
                    Narrator.enabled = this.s.audio;
                    this.bind();
                    this.render();
                },

                bind(){
                    document.addEventListener("click", (e)=>{
                        const act = e.target?.dataset?.action;
                        const val = e.target?.dataset?.value;
                        if (act) this.handle(act, val);
                    });
                },

                handle(act, val) {
                    if (act === "SET_WORLD") this.s.world = val;

                    if (act === "TOGGLE_AUDIO") {
                        this.s.audio = !this.s.audio; Narrator.enabled = this.s.audio;
                        Narrator.speak(this.s.audio ? "Sistema audio attivato." : "");
                    }

                    if (act === "START") {
                        this.s.fsm = "PLAY"; this.s.step = 0;
                        Narrator.speak("Nuova missione. " + this.missions[this.s.world][0]);
                    }

                    if (act === "NEXT") {
                        if (this.s.step < this.missions[this.s.world].length - 1) {
                            this.s.step++;
                            Narrator.speak(this.missions[this.s.world][this.s.step]);
                        } else {
                            this.s.count++; this.s.fsm = "HOME";
                            Narrator.speak("Missione completata. Ottimo lavoro!");
                        }
                    }

                    if (act === "UNLOCK_SPECIAL") {
                        if (prompt("GENITORE: scrivi OK")?.toLowerCase() === "ok") {
                            this.s.specialReady = true; Narrator.speak("Rituale speciale sbloccato.");
                        }
                    }

                    localStorage.setItem(KEY, JSON.stringify(this.s));
                    this.render();
                },

                render() {
                    const { fsm, step, count, audio, world, specialReady } = this.s;
                    const root = document.getElementById("SPARKPLAY_APP");
                    document.body.className = `theme-${world}`;

                    let content = "";
                    if (fsm === "HOME") {
                        content = `
                            <div class="card-game">
                                <div class="world-selector">
                                    <div class="badge-world ${world==='spazio'?'active':''}" data-action="SET_WORLD" data-value="spazio">SPAZIO</div>
                                    <div class="badge-world ${world==='magia'?'active':''}" data-action="SET_WORLD" data-value="magia">MAGIA</div>
                                    <div class="badge-world ${world==='detective'?'active':''}" data-action="SET_WORLD" data-value="detective">DETECTIVE</div>
                                </div>
                                <div class="instruction">In quale mondo vuoi viaggiare oggi?</div>
                                <button class="btn-main btn-${world}" data-action="START">AVVIA MISSIONE</button>
                                ${count >= 3 || specialReady ?
                                    `<button class="btn-main" style="background:var(--gold);color:black;margin-top:15px;" data-action="UNLOCK_SPECIAL">MISSIONE SPECIALE</button>` :
                                    `<div class="special-locked">MISSIONI COMPLETATE: ${count}/3</div>`}
                            </div>`;
                    } else {
                        content = `
                            <div class="card-game">
                                <div style="font-size:12px; opacity:0.5; letter-spacing:2px">MISSIONE ${world.toUpperCase()}</div>
                                <div class="instruction">${this.missions[world][step]}</div>
                                <button class="btn-main btn-${world}" data-action="NEXT">${step === 2 ? 'RITUALE FINALE' : 'FATTO'}</button>
                            </div>`;
                    }

                    root.innerHTML = `
                        <div class="header">
                            <div style="font-weight:900; letter-spacing:2px; font-size:14px;">SPARKPLAY</div>
                            <div data-action="TOGGLE_AUDIO" style="font-size:24px; cursor:pointer;">${audio ? 'ðŸ”Š' : 'ðŸ”‡'}</div>
                        </div>
                        <div class="stage">${content}</div>`;
                }
            };

            App.init();
        })();
    </script>
</body>
</html>