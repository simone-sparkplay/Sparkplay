<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SparkPlay</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
:root {
  --rossa: #ff5e6c; --blu: #00d2ff; --giallo: #ffe66d;
  --sfondo: #0a1128; --latte: #f7fff7;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; background-color: var(--sfondo); font-family: 'Quicksand', sans-serif; 
  color: var(--latte); height: 100vh; overflow: hidden;
  background-image: radial-gradient(circle at 50% 50%, #16224f 0%, var(--sfondo) 100%);
}

/* LO SPARK: ICONA NEUTRA CREATIVA */
.spark-container {
  width: 160px; height: 160px; margin: 0 auto 20px; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.spark-core {
  width: 40px; height: 40px; background: white; border-radius: 50%;
  box-shadow: 0 0 40px 10px white, 0 0 70px 20px var(--blu);
  animation: pulseCore 3s infinite ease-in-out;
}
.spark-ring {
  position: absolute; width: 100%; height: 100%;
  border: 2px dashed rgba(255,255,255,0.2); border-radius: 50%;
  animation: rotateRing 10s linear infinite;
}
@keyframes pulseCore { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }
@keyframes rotateRing { to { transform: rotate(360deg); } }

.sp-root { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: env(safe-area-inset-top) 25px env(safe-area-inset-bottom); position: relative; }
.sp-top { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
.brand { font-family: 'Fredoka One', cursive; font-size: 36px; color: var(--giallo); text-shadow: 3px 3px var(--rossa); }

.content-area { flex: 1; display: flex; flex-direction: column; gap: 20px; justify-content: center; position: relative; }
.testo-storia { font-size: 20px; line-height: 1.4; text-align: center; }
.obiettivo-box { border: 3px dashed var(--blu); border-radius: 25px; padding: 15px; text-align: center; font-weight: 700; color: var(--blu); background: rgba(0,210,255,0.05); }

.passo { padding: 18px; border-radius: 25px; background: rgba(255, 255, 255, 0.08); display: flex; align-items: center; gap: 12px; margin-bottom: 12px; font-weight: 700; transition: 0.3s; }
.passo.attivo { background: var(--latte); color: var(--sfondo); transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

.btn { border: none; font-family: 'Fredoka One', cursive; cursor: pointer; transition: 0.2s; border-radius: 25px; }
.btn-avanti { background: var(--rossa); color: white; padding: 20px; width: 100%; font-size: 20px; box-shadow: 0 6px 0 #c43d4a; }
.btn-avanti:active { transform: translateY(4px); box-shadow: 0 2px 0 #c43d4a; }

/* DIARIO MODERNO CON EMOJI */
#diario-modal { position: fixed; inset: 0; background: linear-gradient(180deg, #101a3b, var(--sfondo)); z-index: 2000; display: none; flex-direction: column; padding: 40px 25px; overflow-y: auto; }
.scheda-ricordo { 
    background: rgba(255,255,255,0.08); padding: 20px; border-radius: 24px; margin-bottom: 15px; 
    border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px;
}
.emoji-diario { font-size: 32px; flex-shrink: 0; }
.testo-diario { flex: 1; }
.testo-diario b { display: block; font-size: 18px; color: var(--giallo); }
.testo-diario small { color: var(--blu); font-weight: 800; font-size: 12px; }

#overlay-success { position: fixed; inset: 0; pointer-events: none; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; background: rgba(10, 17, 40, 0.9); }
.messaggio-vittoria { font-family: 'Fredoka One'; font-size: 48px; color: var(--giallo); text-shadow: 4px 4px var(--rossa); text-align: center; }
.cascata { position: absolute; pointer-events: none; top: -20px; animation: caduta 2s linear forwards; font-size: 28px; }
@keyframes caduta { to { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
</style>
</head>
<body>

<div id="overlay-success"><div class="messaggio-vittoria">MISSIONE<br>COMPLETATA!</div></div>

<div id="diario-modal">
    <div class="sp-top">
        <div class="brand">DIARIO</div>
        <button class="btn" style="background:var(--rossa); color:white; padding:10px 20px;" onclick="chiudiDiario()">CHIUDI</button>
    </div>
    <div id="lista-diario" style="margin-top:20px; padding-bottom:40px;"></div>
</div>

<div id="SPARKPLAY_APP" class="sp-root"></div>

<script>
(()=>{"use strict";
const DB = {
  "5-7": [
    {t:"SEGNALE PERDUTO", e:"üì°", s:"La base ha perso il segnale! La galassia √® al buio!", o:"RIACCENDI L'ANTENNA!", p:["Trova un calzino stellare.","Portalo sulla base (tappeto).","D√¨ 3 Bip! lentamente."]},
    {t:"SATELLITE MORBIDO", e:"üß∏", s:"Un satellite √® caduto tra le stelle!", o:"RECUPERALO!", p:["Trova un peluche-satellite.","Fagli fare un giro intorno al tavolo.","Mettilo a riposare in un posto alto."]},
    {t:"POLVERE DI STELLE", e:"‚ú®", s:"C'√® troppa polvere spaziale sui motori!", o:"PULISCI TUTTO!", p:["Usa le mani come spazzole spaziali.","Pulisci 3 superfici diverse.","Soffia via la polvere."]}
  ],
  "8-10": [
    {t:"MODULO VIBRANTE", e:"‚öôÔ∏è", s:"Il modulo 4 vibra forte. Serve silenzio assoluto!", o:"RIPARA IN SILENZIO", p:["Trova un foglio di carta.","Portalo alla base senza fare rumore.","Piegalo in 4 e mettilo sotto un cuscino."]},
    {t:"CODICE STELLARE", e:"üìü", s:"Dobbiamo inviare un codice segreto alla Terra!", o:"COMPONI IL CODICE", p:["Trova 3 oggetti dello stesso colore.","Mettili in fila dal pi√π piccolo al pi√π grande.","Salta sopra ogni oggetto."]},
    {t:"ANTIGRAVIT√Ä", e:"‚òÅÔ∏è", s:"La gravit√† si √® rotta! Tutto fluttua!", o:"MUOVITI LENTO", p:["Attraversa la stanza al rallentatore.","Tocca terra solo con le punte dei piedi.","Siediti senza usare le mani."]}
  ],
  speciale: {t:"MISSIONE SINCRONIA ü§ù", e:"ü§ù", s:"I motori hanno bisogno di due piloti insieme!", o:"SQUADRA SPAZIALE", p:["Prendetevi per mano (Genitore + Bambino).","Fate 10 passi sincronizzati insieme.","Dite 'Pronti al lancio' nello stesso istante!"], f:"Siete una squadra imbattibile!"}
};

const FRASI = ["L'immaginazione √® l'unica astronave che arriva ovunque.", "Il gioco √® il lavoro pi√π serio del mondo.", "Un piccolo Spark accende una grande avventura."];

let s = { fsm:"INIZIO", eta:null, passo:0, missioniFatte:0, missioneAttuale:null, audio:false, diario: [], specialeFatta: false };

function caricaStato() {
    const salvato = localStorage.getItem('sparkplay_diario');
    if(salvato) s.diario = JSON.parse(salvato);
}
function salvaStato() {
    localStorage.setItem('sparkplay_diario', JSON.stringify(s.diario));
}

function parla(testo){
  if(!s.audio) return;
  speechSynthesis.cancel();
  const m = new SpeechSynthesisUtterance(testo);
  m.lang="it-IT"; m.rate=0.9;
  speechSynthesis.speak(m);
}

function celebra() {
  const overlay = document.getElementById("overlay-success");
  overlay.style.display = "flex";
  for(let i=0; i<18; i++) {
    const stella = document.createElement("div");
    stella.className = "cascata";
    stella.innerHTML = "‚≠ê";
    stella.style.left = Math.random() * 100 + "vw";
    document.body.appendChild(stella);
    setTimeout(() => stella.remove(), 2000);
  }
  setTimeout(() => { overlay.style.display = "none"; }, 2000);
}

function disegna(){
  const root = document.getElementById("SPARKPLAY_APP");

  if(s.fsm === "INIZIO"){
    root.innerHTML = `<div class="sp-top">
        <button class="btn" style="background:none;font-size:32px;" onclick="apriDiario()">üìö</button>
        <div class="brand">SPARKPLAY</div>
        <button class="btn" style="background:none;font-size:32px;" onclick="toggleAudio()">${s.audio?'üîä':'üîà'}</button>
      </div>
      <div class="content-area">
        <div class="spark-container">
            <div class="spark-ring"></div>
            <div class="spark-core"></div>
        </div>
        <h1 style="text-align:center;color:var(--giallo);font-size:48px;margin:0;">PRONTI?</h1>
        <button class="btn btn-avanti" style="width:80%; margin:20px auto 0;" onclick="vaiEta()">INIZIA MISSIONE</button>
        <div style="margin-top:40px; font-style:italic; text-align:center; color:var(--giallo); padding:0 20px; font-size:14px; opacity:0.8;">"${FRASI[Math.floor(Math.random()*FRASI.length)]}"</div>
      </div>`;
  } 
  else if(s.fsm === "ETA"){
    root.innerHTML = `<div class="sp-top"><div class="brand">CHI SEI?</div></div>
      <div class="content-area">
        <button class="btn" style="background:rgba(0,210,255,0.15); border:3px solid var(--blu); color:white; padding:25px; font-size:24px; margin-bottom:15px; border-radius:30px;" onclick="scegliEta('5-7')">ESPLORATORE (5-7)</button>
        <button class="btn" style="background:rgba(255,94,108,0.15); border:3px solid var(--rossa); color:white; padding:25px; font-size:24px; border-radius:30px;" onclick="scegliEta('8-10')">COMANDANTE (8-10)</button>
      </div>`;
  }
  else if(s.fsm === "GIOCO"){
    const m = s.missioneAttuale;
    root.innerHTML = `<div class="sp-top">
        <button class="btn" style="background:none;font-size:32px;" onclick="toggleAudio()">${s.audio?'üîä':'üîà'}</button>
        <div class="brand" style="font-size:20px">${m.t}</div>
        <button class="btn" style="background:rgba(255,255,255,0.1);color:white;padding:8px 15px;border-radius:15px;" onclick="home()">ESCI</button>
      </div>
      <div class="content-area">
        <div class="testo-storia">${m.s}</div>
        <div class="obiettivo-box">OBIETTIVO: ${m.o}</div>
        <div class="passaggi">${m.p.map((t,i)=>`<div class="passo ${i===s.passo?'attivo':(i<s.passo?'':'sfumato')}"><div style="background:var(--rossa);color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;font-size:16px;">${i+1}</div>${t}</div>`).join('')}</div>
        <div style="display:flex;gap:15px;margin-top:10px;">
          <button class="btn" style="background:rgba(255,255,255,0.1);color:white;flex:1;padding:15px;" onclick="precedente()" ${s.passo===0?'style="visibility:hidden"':''}>INDIETRO</button>
          <button class="btn btn-avanti" style="flex:2;" onclick="successivo()">${s.passo < m.p.length-1 ? 'AVANTI' : 'COMPLETA ‚úÖ'}</button>
        </div>
      </div>`;
  }
  else if(s.fsm === "SCELTA_GENITORE"){
    const btnSpeciale = s.specialeFatta ? '' : `<button class="btn" style="background:var(--blu);color:white;padding:22px;width:100%;margin-bottom:18px;font-size:20px;" onclick="sblocca('SPECIALE')">MISSIONE SPECIALE ü§ù</button>`;
    root.innerHTML = `<div class="sp-top"><div class="brand">GENITORE</div></div>
      <div class="content-area">
        <h2 style="text-align:center;font-size:32px;color:var(--giallo);">CAPITOLO FINITO! üèÜ</h2>
        ${btnSpeciale}
        <button class="btn" style="background:rgba(255,255,255,0.1);color:white;padding:22px;width:100%;margin-bottom:18px;font-size:20px;" onclick="sblocca('ALTRE')">FAI ALTRE 3 MISSIONI üöÄ</button>
        <button class="btn" style="background:var(--rossa);color:white;padding:15px;width:100%;font-size:18px;" onclick="home()">FINISCI PER OGGI</button>
      </div>`;
  }
}

window.apriDiario = () => {
    const lista = document.getElementById("lista-diario");
    lista.innerHTML = s.diario.length ? s.diario.map(m => `
        <div class="scheda-ricordo">
            <div class="emoji-diario">${m.emoji || '‚≠ê'}</div>
            <div class="testo-diario">
                <small>${m.data}</small>
                <b>${m.titolo}</b>
            </div>
        </div>`).join('') : "<p style='text-align:center;opacity:0.6;'>Il tuo diario √® vuoto. Inizia una missione!</p>";
    document.getElementById("diario-modal").style.display = "flex";
}
window.chiudiDiario = () => { document.getElementById("diario-modal").style.display = "none"; }
window.toggleAudio = () => { s.audio = !s.audio; if(s.audio) parla("Audio attivato"); else speechSynthesis.cancel(); disegna(); };
window.vaiEta = () => { s.fsm = "ETA"; disegna(); };
window.scegliEta = (e) => { s.eta = e; s.missioniFatte = 0; s.specialeFatta = false; s.fsm = "GIOCO"; proproxima(); };
window.home = () => { s.fsm = "INIZIO"; s.passo=0; s.missioniFatte=0; s.missioneAttuale=null; s.specialeFatta = false; disegna(); };

window.sblocca = (tipo) => {
  const pin = prompt("GENITORE: Quanto fa 4 + 4?");
  if(pin === "8") {
    if(tipo === 'SPECIALE') {
      s.missioneAttuale = DB.speciale; s.fsm = "GIOCO"; s.passo = 0; s.specialeFatta = true; disegna();
    } else {
      s.missioniFatte = 0; s.specialeFatta = false; s.fsm = "GIOCO"; proproxima();
    }
  } else if (pin !== null) alert("PIN Errato!");
};

function proproxima(){
  if(s.missioniFatte < 3){
    s.missioneAttuale = DB[s.eta][s.missioniFatte];
    s.passo = 0; s.fsm = "GIOCO"; disegna();
    parla(s.missioneAttuale.s + " Obiettivo: " + s.missioneAttuale.o);
  } else { s.fsm = "SCELTA_GENITORE"; disegna(); }
}

window.successivo = () => {
  if(s.passo < s.missioneAttuale.p.length - 1){
    s.passo++; disegna(); parla(s.missioneAttuale.p[s.passo]);
  } else {
    celebra();
    s.diario.unshift({ titolo: s.missioneAttuale.t, emoji: s.missioneAttuale.e, data: new Date().toLocaleDateString('it-IT') });
    salvaStato();
    setTimeout(() => { 
        document.getElementById("overlay-success").style.display = "none";
        if (s.fsm === "GIOCO" && s.missioneAttuale === DB.speciale) {
            s.fsm = "SCELTA_GENITORE"; disegna();
        } else {
            s.missioniFatte++; proproxima(); 
        }
    }, 2000);
  }
};
window.precedente = () => { if(s.passo > 0){ s.passo--; disegna(); parla(s.missioneAttuale.p[s.passo]); } };

caricaStato();
disegna();
})();
</script>
</body>
</html>
