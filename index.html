<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SparkPlay -- Spazio</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --coral:#ff5e6c;
      --cyan:#00d2ff;
      --yellow:#ffe66d;
      --bg:#0a1128;
      --white:#f7fff7;

      --glass:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.12);

      --safe-top:env(safe-area-inset-top);
      --safe-bottom:env(safe-area-inset-bottom);

      /* UI */
      --radius:28px;
      --radiusBtn:22px;
      --shadow: 0 10px 28px rgba(0,0,0,.26);

      /* Sizing */
      --headerH:70px;
      --pad:16px;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Quicksand',sans-serif;
      color:var(--white);
      background: radial-gradient(circle at 50% 45%, #1a2a5a 0%, #0a1128 55%, #070d20 100%);
      overflow:hidden; /* niente scroll pagina */
    }

    header{
      position:fixed;top:0;left:0;right:0;
      height: calc(var(--headerH) + var(--safe-top));
      padding-top: var(--safe-top);
      display:flex;align-items:center;justify-content:space-between;
      padding-left:20px;padding-right:20px;
      background: rgba(10,17,40,.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      z-index: 100;
      border-bottom: 1px solid var(--stroke);
    }
    .brand-group{text-align:center;flex:1;pointer-events:none}
    .brand{
      font-family:'Fredoka One',cursive;
      font-size:24px;color:var(--yellow);
      text-shadow:2px 2px rgba(255,94,108,.65);
      margin:0;
      letter-spacing:.5px;
    }
    .sub-brand{font-size:13px;font-weight:800;color:var(--cyan);letter-spacing:2px;text-transform:uppercase}

    .btn-header{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.10);
      color:#fff;font-size:22px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .08s ease;
    }
    .btn-header:active{transform:scale(.98)}

    /* Area app (niente scroll globale) */
    #main-container{
      position:fixed;
      top: calc(var(--headerH) + var(--safe-top));
      left:0; right:0;
      bottom:0;
      padding: var(--pad) var(--pad) calc(var(--pad) + var(--safe-bottom));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .screen{
      display:none;
      width:100%;
      max-width:520px;
      height:100%;
      align-items:center;
      justify-content:center;
    }
    .screen.active{display:flex;animation: fadeIn .25s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .card{
      width:100%;
      max-height:100%;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:14px;
      overflow:hidden; /* niente scroll dentro la card (tranne dove dichiarato) */
    }

    /* Bottoni: NO ombre pesanti */
    .btn-big{
      width:100%;
      border:none;
      border-radius: var(--radiusBtn);
      padding: 16px 18px;
      font-family:'Fredoka One',cursive;
      font-size: 22px;
      cursor:pointer;
      color:#fff;
      background: var(--coral);
      box-shadow:none;
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .08s ease;
    }
    .btn-big:active{transform: scale(.99)}
    .btn-cyan{background: var(--cyan)}
    .btn-yellow{background: var(--yellow); color: #0a1128}
    .btn-muted{background:#4a5568;color:#fff}

    .chip-row{display:flex;gap:10px;justify-content:center}
    .chip{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      padding: 8px 14px;
      border-radius:18px;
      font-size:13px;
      font-weight:800;
      min-width:110px;
      text-align:center;
    }

    /* HOME orbit: icone SVG (compatibili ovunque) */
    .multiverso-wrap{
      width: 240px; height: 240px;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 0 auto;
    }
    .center-spark{
      width: 66px; height: 66px;
      background:#fff;
      border-radius:50%;
      box-shadow: 0 0 34px rgba(255,230,109,.55);
      display:flex;align-items:center;justify-content:center;
      z-index:2;
      color:#ffd65a;
      font-size:30px;
      font-family:'Fredoka One',cursive;
    }
    .orbit-icon{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:48px;height:48px;
      opacity:.95;
      animation: orbit 10s linear infinite;
      transform-origin:center;
      will-change: transform;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,.35));
    }
    .o1{animation-delay:0s}
    .o2{animation-delay:-3.3s}
    .o3{animation-delay:-6.6s}
    @keyframes orbit{
      from{transform: translate(-50%,-50%) rotate(0deg) translateX(98px) rotate(0deg)}
      to{transform: translate(-50%,-50%) rotate(360deg) translateX(98px) rotate(-360deg)}
    }
    .orbit-icon svg{width:100%;height:100%}
    .stroke-white{stroke:#f7fff7}
    .fill-cyan{fill:rgba(0,210,255,.18)}
    .fill-coral{fill:rgba(255,94,108,.18)}
    .fill-yellow{fill:rgba(255,230,109,.18)}

    /* ETA */
    .title{
      font-family:'Fredoka One',cursive;
      font-size:46px;
      margin:0;
      color:var(--yellow);
      text-align:center;
      line-height:1;
    }
    .subtitle{
      font-family:'Fredoka One',cursive;
      font-size:26px;
      margin:0;
      color:var(--yellow);
      text-align:center;
    }

    .btn-link{
      background:none;
      border:none;
      color:#eaf2ff;
      opacity:.85;
      font-weight:800;
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn-link:active{transform:scale(.99)}

    /* GIOCO: tutto visibile (no scroll) */
    #screen-gioco .card{
      align-items:stretch;
      justify-content:flex-start;
      gap:10px;
      padding:14px;
    }
    .mission-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mini-pill{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:14px;
      font-size:12px;
      font-weight:900;
      color:#eaf2ff;
      white-space:nowrap;
    }
    .mission-title{
      font-family:'Fredoka One',cursive;
      font-size: 20px;
      color: var(--yellow);
      margin: 0;
      text-align:center;
    }
    .mission-story{
      font-size: 15px;
      line-height: 1.25;
      color: #cbd5e1;
      margin: 0;
      text-align:center;
    }
    .objective-box{
      background: rgba(0,210,255,.10);
      border: 2px dashed var(--cyan);
      border-radius: 18px;
      padding: 10px 12px;
      text-align:center;
    }
    .objective-box b{
      display:block;
      color: var(--cyan);
      letter-spacing:2px;
      margin-bottom:4px;
      text-transform:uppercase;
      font-size: 12px;
    }

    .steps-wrap{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 1;
      min-height: 0;
      overflow:hidden; /* niente scroll */
    }
    .step{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      opacity: .30;
      transition:.2s;
    }
    .step.active{
      opacity:1;
      background: rgba(255,255,255,.14);
      border: 2px solid rgba(255,230,109,.75);
      transform: scale(1.01);
    }
    .step-num{
      width:30px;height:30px;
      border-radius:50%;
      background: var(--coral);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      flex-shrink:0;
    }

    .game-controls{
      display:flex;
      gap:10px;
      width:100%;
      margin-top:2px;
    }
    .btn-ctrl{
      flex:1;
      padding: 12px 10px;   /* pi√π piccolo, cos√¨ non "taglia" */
      border-radius: 18px;
      border:none;
      font-family:'Fredoka One',cursive;
      font-size: 17px;
      cursor:pointer;
      color:#fff;
      box-shadow:none;
    }

    /* Overlay complete */
    #overlay-complete{
      position:fixed;inset:0;
      background: rgba(10,17,40,.92);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
      padding:30px;
    }

    /* DIARIO: niente emoji ripetitive, niente barrette colorate, solo lista pulita */
    #overlay-diario{
      position:fixed;inset:0;
      background: radial-gradient(circle at 50% 20%, rgba(0,210,255,.10), transparent 42%),
                  radial-gradient(circle at 20% 90%, rgba(255,94,108,.10), transparent 42%),
                  var(--bg);
      z-index:2000;
      display:none;
      flex-direction:column;
      padding: calc(var(--safe-top) + 18px) 18px calc(18px + var(--safe-bottom));
      overflow:hidden;
    }
    .diary-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
    }
    .diary-title{
      font-family:'Fredoka One',cursive;
      font-size:32px;
      margin:0;
      color: var(--white);
      letter-spacing:1px;
    }
    .diary-sub{
      font-weight:800;
      color: var(--cyan);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size: 12px;
      margin-top:4px;
    }
    .diary-list{
      flex:1;
      overflow:auto; /* qui serve, altrimenti non vedi le vecchie */
      -webkit-overflow-scrolling:touch;
      padding-right:4px;
    }
    .diary-entry{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      padding: 14px 14px;
      border-radius: 22px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .diary-left{min-width:0}
    .diary-left b{
      display:block;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .diary-left small{
      opacity:.75;
      font-weight:800;
    }
    .diary-meta{
      font-size:12px;
      color: var(--cyan);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1px;
      flex-shrink:0;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.10);
      min-width:54px;
      text-align:center;
    }

    /* Parent gate */
    #parent-gate{
      position:fixed;inset:0;
      background: rgba(0,0,0,.82);
      z-index:3000;
      display:none;
      align-items:center;justify-content:center;
      padding: 20px;
    }
    .gate-box{
      width:100%;
      max-width:340px;
      background:#1e293b;
      border-radius: 30px;
      border: 2px solid var(--cyan);
      padding: 22px;
      text-align:center;
      box-shadow: var(--shadow);
    }
    .gate-box h3{
      font-family:'Fredoka One',cursive;
      color: var(--cyan);
      margin: 0 0 6px;
      letter-spacing:1px;
    }
    .gate-box p{margin:0 0 14px;opacity:.9;font-weight:800}
    .gate-box input{
      width:100%;
      padding: 16px;
      border-radius: 16px;
      border:none;
      margin: 10px 0 16px;
      font-size: 28px;
      text-align:center;
      background:#0f172a;color:#fff;
      -webkit-appearance:none;
    }
    .gate-actions{display:flex;gap:10px}
    .gate-actions button{flex:1}

    /* Genitore */
    #screen-genitore .card{gap:12px}
    .trophy{font-size:62px;margin-bottom:2px}
    .gen-text{opacity:.85;margin: 0;font-weight:800;text-align:center}

    /* Riduzioni smart per schermi bassi */
    @media (max-height: 720px){
      .multiverso-wrap{width:220px;height:220px}
      .title{font-size:44px}
      .btn-big{font-size:21px;padding:15px 16px}
      #screen-gioco .card{padding:12px}
      .mission-story{font-size:14px}
      .btn-ctrl{font-size:16px;padding:11px 10px}
    }
  </style>
</head>

<body>

<header>
  <button class="btn-header" onclick="spark.openDiary()" aria-label="Diario">üìö</button>
  <div class="brand-group">
    <h1 class="brand">SPARKPLAY</h1>
    <div class="sub-brand">Spazio</div>
  </div>
  <button class="btn-header" id="audioBtn" onclick="spark.toggleAudio()" aria-label="Audio">üîä</button>
</header>

<div id="main-container">

  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="card">
      <div class="multiverso-wrap" aria-hidden="true">
        <div class="center-spark">‚ú¶</div>

        <!-- Rocket -->
        <div class="orbit-icon o1">
          <svg viewBox="0 0 64 64" fill="none">
            <path class="stroke-white" d="M38 6c9 3 16 10 20 20-4 9-11 16-20 20-4-4-8-10-10-17-1-4-1-7 0-11 2-7 6-12 10-12Z" stroke-width="3" stroke-linejoin="round"/>
            <path class="stroke-white" d="M20 34l-8 8 10-2 2-6-4 0Z" stroke-width="3" stroke-linejoin="round"/>
            <circle cx="43" cy="21" r="4" class="stroke-white" stroke-width="3"/>
            <path d="M30 44c-2 6-6 10-12 12 2-6 6-10 12-12Z" class="fill-coral"/>
          </svg>
        </div>

        <!-- Wand -->
        <div class="orbit-icon o2">
          <svg viewBox="0 0 64 64" fill="none">
            <path class="stroke-white" d="M18 46L46 18" stroke-width="3" stroke-linecap="round"/>
            <path class="stroke-white" d="M40 14l10-4-4 10" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            <path class="stroke-white" d="M46 24l8 2-6 6-2-8Z" stroke-width="3" stroke-linejoin="round"/>
            <circle cx="18" cy="46" r="6" class="stroke-white" stroke-width="3"/>
            <path d="M50 10l4 4-4 10-10 4-4-4 14-14Z" class="fill-yellow"/>
          </svg>
        </div>

        <!-- Magnifier -->
        <div class="orbit-icon o3">
          <svg viewBox="0 0 64 64" fill="none">
            <circle cx="28" cy="28" r="14" class="stroke-white" stroke-width="3"/>
            <path class="stroke-white" d="M38 38l14 14" stroke-width="3" stroke-linecap="round"/>
            <path d="M16 28c0-7 5-12 12-12" class="fill-cyan"/>
          </svg>
        </div>
      </div>

      <h2 class="title">PRONTI?</h2>

      <button class="btn-big" onclick="spark.goToEta()">AVVIA MISSIONE</button>

      <div class="chip-row">
        <div class="chip" id="chip-today">OGGI: 0/3</div>
        <div class="chip" id="chip-eta">ET√Ä: --</div>
      </div>
    </div>
  </section>

  <!-- ETA -->
  <section id="screen-eta" class="screen">
    <div class="card">
      <h2 class="subtitle">Quanti anni hai?</h2>
      <button class="btn-big" onclick="spark.selectEta('5-7')">5 - 7 ANNI</button>
      <button class="btn-big btn-cyan" onclick="spark.selectEta('8-10')">8 - 10 ANNI</button>
      <button class="btn-link" onclick="spark.showScreen('home')">Indietro</button>
    </div>
  </section>

  <!-- GIOCO -->
  <section id="screen-gioco" class="screen">
    <div class="card">
      <div class="mission-topbar">
        <span class="mini-pill" id="pill-eta">ET√Ä: --</span>
        <button class="btn-link" onclick="spark.backToEta()">‚üµ Indietro</button>
      </div>

      <h2 class="mission-title" id="mission-title"></h2>
      <p class="mission-story" id="mission-story"></p>

      <div class="objective-box" id="mission-goal"></div>

      <div class="steps-wrap" id="mission-steps"></div>

      <div class="game-controls">
        <button id="btn-back" class="btn-ctrl" style="background:#4a5568;" onclick="spark.prevStep()">INDIETRO</button>
        <button id="btn-next" class="btn-ctrl" style="background:var(--coral);" onclick="spark.nextStep()">AVANTI</button>
      </div>
    </div>
  </section>

  <!-- GENITORE -->
  <section id="screen-genitore" class="screen">
    <div class="card">
      <div class="trophy">üèÜ</div>
      <h2 class="subtitle" style="font-size:30px;margin:0;">CAPITOLO FINITO!</h2>
      <div class="gen-text">Hai completato le missioni di oggi!</div>

      <button class="btn-big btn-yellow" id="btn-special" onclick="spark.askParent('spec')">MISSIONE SPECIALE ü§ù</button>
      <button class="btn-big btn-cyan" onclick="spark.askParent('more')">FAI ALTRE 3 MISSIONI üöÄ</button>
      <button class="btn-big btn-muted" onclick="spark.finishToday()">FINISCI PER OGGI</button>
    </div>
  </section>

</div>

<!-- COMPLETATA -->
<div id="overlay-complete">
  <div style="font-size:110px;">üåü</div>
  <h2 style="font-family:'Fredoka One',cursive;font-size:44px;color:var(--yellow);margin:10px 0 0;">MISSIONE<br>COMPLETATA!</h2>
</div>

<!-- DIARIO -->
<div id="overlay-diario">
  <div class="diary-header">
    <div>
      <h2 class="diary-title">DIARIO <span style="opacity:.9">üìö</span></h2>
      <div class="diary-sub">I tuoi ricordi</div>
    </div>
    <button class="btn-header" style="background: rgba(255,94,108,.90);" onclick="spark.closeDiary()">‚úï</button>
  </div>
  <div class="diary-list" id="diary-list"></div>
</div>

<!-- PARENT GATE -->
<div id="parent-gate">
  <div class="gate-box">
    <h3>AREA GENITORI</h3>
    <p>Quanto fa 5 + 5?</p>
    <input type="number" id="gate-input" pattern="[0-9]*" inputmode="numeric" placeholder="?">
    <div class="gate-actions">
      <button class="btn-ctrl" style="background:#4a5568;" onclick="spark.closeParent()">CHIUDI</button>
      <button class="btn-ctrl" style="background:var(--cyan);" onclick="spark.verifyParent()">SBLOCCA</button>
    </div>
  </div>
</div>

<script>
  const DB = {
    "5-7": [
      { id:"s1", t:"Antenna Spaziale", s:"La base ha perso il segnale satellitare.", o:"Crea un'antenna magica.", p:["Trova un cucchiaio o un oggetto lungo.","Portalo vicino a una finestra e tienilo in alto.","D√¨ 'Bip Bip Bip' per 3 volte."] },
      { id:"s2", t:"Polvere di Stelle", s:"Un'onda di polvere ha coperto i motori.", o:"Pulisci i pannelli solari.", p:["Prendi un calzino o un panno morbido.","Pulisci tre superfici diverse nella stanza.","Soffia forte su ogni punto pulito!"] },
      { id:"s3", t:"Gravit√† Zero", s:"Il computer ha tolto la gravit√†!", o:"Muoviti come se fluttuassi.", p:["Fai 5 passi lentissimi alzando molto le ginocchia.","Tocca un mobile alto con la punta delle dita.","Fai un salto e atterra senza fare rumore."] },
      { id:"s4", t:"Ghiaccio Stellare", s:"Serve energia fredda per il reattore.", o:"Recupera i cristalli spaziali.", p:["Trova 5 piccoli oggetti bianchi in casa.","Portali uno alla volta nella tua base.","Mettili in ordine dal pi√π piccolo al pi√π grande."] },
      { id:"s5", t:"Mappa Galattica", s:"Le stelle sono disordinate oggi.", o:"Riordina la mappa dei pianeti.", p:["Trova tre cuscini o tre libri.","Mettili a terra creando un triangolo.","Salta dentro al triangolo e d√¨ 'Orbita!'"] },
      { id:"s6", t:"Luci di Emergenza", s:"L'astronave √® troppo buia.", o:"Riaccendi le luci di bordo.", p:["Tocca 4 angoli diversi della stanza.","D√¨ 'Clic' ogni volta che ne tocchi uno.","Torna al centro e batti le mani."] }
    ],
    "8-10": [
      { id:"b1", t:"Riparazione Modulo", s:"Un bullone si √® allentato fuori dallo scafo.", o:"Esegui una riparazione tecnica.", p:["Trova un oggetto con tappo a vite (es. bottiglia).","Svita e riavvita il tappo per 5 volte.","Stringi fortissimo alla fine e d√¨ 'Fatto!'"] },
      { id:"b2", t:"Codice Binario", s:"Dobbiamo inviare un segnale criptato.", o:"Componi il ritmo del codice.", p:["Batti le mani 3 volte forte e 2 piano.","Ripeti la sequenza saltando sul posto.","Fai un inchino spaziale verso la Terra."] },
      { id:"b3", t:"Scanner Alieno", s:"Il radar ha intercettato un oggetto ignoto.", o:"Analizza l'area intorno a te.", p:["Chiudi gli occhi e ascolta per 10 secondi.","Trova un oggetto che non hai mai toccato oggi.","Descrivi a voce alta di che materiale √® fatto."] },
      { id:"b4", t:"Navigazione Silenziosa", s:"Dobbiamo passare vicino a un buco nero.", o:"Attraversa il settore senza rumore.", p:["Cammina per la stanza senza far sentire i passi.","Sposta una sedia senza strisciarla a terra.","Siediti lentamente senza fare alcun suono."] },
      { id:"b5", t:"Equilibrio Orbitale", s:"L'astronave sta oscillando troppo.", o:"Stabilizza il centro di massa.", p:["Metti un libro o un cuscino sulla testa.","Fai 5 passi senza farlo cadere.","Girati su te stesso e siediti piano."] },
      { id:"b6", t:"Lancio d'Emergenza", s:"La capsula deve essere pronta al distacco.", o:"Controlla i sistemi di lancio.", p:["Fai 10 saltelli sul posto velocissimi.","Fai 3 respiri profondi per calmare il cuore.","Conta da 10 a 0 a voce alta e d√¨ 'Lancio!'"] }
    ],
    "spec": { id:"spec", t:"Sincronia Stellare ü§ù", s:"I motori richiedono due piloti sincronizzati.", o:"Muovetevi insieme.", p:["Prendetevi per mano (Genitore e Bambino).","Fate 10 passi sincronizzati senza lasciarvi.","Sussurrate 'Pronti al lancio' nello stesso istante!"] }
  };

  const spark = {
    state: {
      dayKey: "",
      missionsDoneToday: 0,
      specialDoneToday: false,
      usedMissionIds: [],
      diary: [],
      audioOn: true,
      eta: null,
      currentMissionId: null,
      passo: 0,
      fsm: "home"
    },

    _todayISO(){ return new Date().toISOString().slice(0,10); },

    init(){
      const saved = localStorage.getItem("sparkplay_spazio_state_v2");
      const today = this._todayISO();

      if(saved){
        try{
          const parsed = JSON.parse(saved);

          // sempre dietro diario/audio
          this.state.diary = parsed.diary || [];
          this.state.audioOn = (parsed.audioOn !== undefined) ? parsed.audioOn : true;

          if(parsed.dayKey === today){
            this.state = Object.assign(this.state, parsed);
          }else{
            this.state.dayKey = today;
            this.state.missionsDoneToday = 0;
            this.state.specialDoneToday = false;
            this.state.usedMissionIds = [];
            this.state.currentMissionId = null;
            this.state.passo = 0;
            this.state.fsm = "home";
            this.state.eta = null;
          }
        }catch(e){
          this.state.dayKey = today;
        }
      }else{
        this.state.dayKey = today;
      }

      this.updateUI();
    },

    save(){
      localStorage.setItem("sparkplay_spazio_state_v2", JSON.stringify(this.state));
    },

    showScreen(id){
      // stop audio on navigation (evita "audio che va da solo" tra schermate)
      window.speechSynthesis.cancel();

      this.state.fsm = id;
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const target = document.getElementById("screen-" + id);
      if(target) target.classList.add("active");

      this.updateChips();
      this.save();
    },

    updateChips(){
      const done = Math.min(3, this.state.missionsDoneToday || 0);
      document.getElementById("chip-today").innerText = `OGGI: ${done}/3`;
      document.getElementById("chip-eta").innerText = `ET√Ä: ${this.state.eta || "--"}`;
      document.getElementById("audioBtn").innerText = this.state.audioOn ? "üîä" : "üîà";
    },

    updateUI(){
      this.state.missionsDoneToday = Math.min(3, this.state.missionsDoneToday || 0);

      const btnSpecial = document.getElementById("btn-special");
      if(btnSpecial) btnSpecial.style.display = this.state.specialDoneToday ? "none" : "block";

      this.updateChips();
      this.showScreen(this.state.fsm);

      if(this.state.fsm === "gioco" && this.state.currentMissionId){
        this.renderMission();
      }
    },

    toggleAudio(){
      this.state.audioOn = !this.state.audioOn;
      if(!this.state.audioOn) window.speechSynthesis.cancel();
      this.updateChips();
      this.save();
    },

    speak(text){
      if(!this.state.audioOn) return;
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "it-IT";
      msg.rate = 0.9;   // stabile su iPhone/Android
      msg.pitch = 1.0;
      window.speechSynthesis.speak(msg);
    },

    goToEta(){ this.showScreen("eta"); },

    backToEta(){
      // torna a scelta et√† senza rompere lo stato
      this.showScreen("eta");
    },

    selectEta(val){
      this.state.eta = val;
      this.loadMission();
    },

    pickMissionId(){
      const pool = DB[this.state.eta] || [];
      const available = pool.filter(m => !this.state.usedMissionIds.includes(m.id));
      const chosen = available.length ? available[0] : pool[0];
      return chosen ? chosen.id : null;
    },

    getMission(){
      if(this.state.currentMissionId === "spec") return DB["spec"];
      const pool = DB[this.state.eta] || [];
      return pool.find(x => x.id === this.state.currentMissionId) || pool[0];
    },

    loadMission(){
      if(!this.state.eta){ this.showScreen("eta"); return; }

      const id = this.pickMissionId();
      if(!id){ this.showScreen("eta"); return; }

      this.state.currentMissionId = id;
      this.state.passo = 0;

      this.renderMission();
      this.showScreen("gioco");

      const m = this.getMission();
      // parla SOLO qui (non in refresh/screen change)
      this.speak(m.s + ". Obiettivo: " + m.o + ". Passaggio 1: " + m.p[0]);

      this.save();
    },

    renderMission(){
      const m = this.getMission();
      if(!m) return;

      document.getElementById("pill-eta").innerText = `ET√Ä: ${this.state.eta || "--"}`;
      document.getElementById("mission-title").innerText = m.t;
      document.getElementById("mission-story").innerText = m.s;
      document.getElementById("mission-goal").innerHTML = `<b>OBIETTIVO</b>${m.o}`;

      const steps = document.getElementById("mission-steps");
      steps.innerHTML = "";
      m.p.forEach((txt, i) => {
        const div = document.createElement("div");
        div.className = "step" + (i === this.state.passo ? " active" : "");
        div.innerHTML = `<div class="step-num">${i+1}</div><div>${txt}</div>`;
        steps.appendChild(div);
      });

      document.getElementById("btn-back").style.visibility = this.state.passo === 0 ? "hidden" : "visible";
      document.getElementById("btn-next").innerText = (this.state.passo === m.p.length - 1) ? "COMPLETA ‚úÖ" : "AVANTI";
    },

    nextStep(){
      const m = this.getMission();
      if(!m) return;

      if(this.state.passo < m.p.length - 1){
        this.state.passo++;
        this.renderMission();
        this.speak("Passaggio " + (this.state.passo+1) + ": " + m.p[this.state.passo]);
        this.save();
      }else{
        this.completeMission(m);
      }
    },

    prevStep(){
      if(this.state.passo > 0){
        this.state.passo--;
        this.renderMission();
        this.save();
      }
    },

    completeMission(m){
      const overlay = document.getElementById("overlay-complete");
      overlay.style.display = "flex";

      // come richiesto: SOLO "Missione completata!"
      this.speak("Missione completata!");

      setTimeout(() => {
        overlay.style.display = "none";

        if(m.id !== "spec"){
          this.state.missionsDoneToday = Math.min(3, (this.state.missionsDoneToday || 0) + 1);
          this.state.usedMissionIds.push(m.id);

          this.state.diary.unshift({
            t: m.t,
            d: new Date().toLocaleDateString("it-IT"),
            e: this.state.eta,
            id: m.id
          });
          if(this.state.diary.length > 80) this.state.diary.pop();

          this.state.currentMissionId = null;
          this.state.passo = 0;

          if(this.state.missionsDoneToday >= 3){
            this.showScreen("genitore");
          }else{
            this.loadMission();
          }
        }else{
          this.state.specialDoneToday = true;
          this.state.currentMissionId = null;
          this.state.passo = 0;
          this.showScreen("genitore");
        }

        this.updateUI();
        this.save();
      }, 1200);
    },

    // Diario (pulito, senza emoji ripetitive)
    openDiary(){
      const list = document.getElementById("diary-list");

      if(!this.state.diary.length){
        list.innerHTML = `<div style="opacity:.75;text-align:center;margin-top:60px;font-weight:900;">
          Diario vuoto.<br><span style="opacity:.85;font-weight:800;">Completa una missione e torna qui ‚ú®</span>
        </div>`;
      }else{
        list.innerHTML = this.state.diary.map(d => `
          <div class="diary-entry">
            <div class="diary-left">
              <b>${d.t}</b>
              <small>${d.d}</small>
            </div>
            <div class="diary-meta">${d.e || ""}</div>
          </div>
        `).join("");
      }

      document.getElementById("overlay-diario").style.display = "flex";
      this.save();
    },

    closeDiary(){
      document.getElementById("overlay-diario").style.display = "none";
    },

    // Parent gate
    askParent(action){
      window.parentTask = action;
      document.getElementById("gate-input").value = "";
      document.getElementById("parent-gate").style.display = "flex";
      window.speechSynthesis.cancel();
    },

    closeParent(){
      document.getElementById("parent-gate").style.display = "none";
    },

    verifyParent(){
      const val = document.getElementById("gate-input").value;

      if(val === "10"){
        this.closeParent();

        if(window.parentTask === "spec"){
          this.state.currentMissionId = "spec";
          this.state.passo = 0;
          this.renderMission();
          this.showScreen("gioco");
          const ms = DB["spec"];
          this.speak(ms.s + ". Obiettivo: " + ms.o + ". Passaggio 1: " + ms.p[0]);
        }else{
          this.state.missionsDoneToday = 0;
          this.state.usedMissionIds = [];
          this.state.specialDoneToday = false;
          this.state.currentMissionId = null;
          this.state.passo = 0;
          this.showScreen("eta");
        }

        this.save();
        this.updateUI();
      }else{
        alert("Risposta errata!");
        this.closeParent();
      }
    },

    finishToday(){
      // niente spezzature: torna in Home pulito
      window.speechSynthesis.cancel();

      this.state.fsm = "home";
      this.state.eta = null;
      this.state.currentMissionId = null;
      this.state.passo = 0;

      this.save();
      this.updateUI();
      this.showScreen("home");
    }
  };

  window.onload = () => spark.init();
</script>

</body>
</html>