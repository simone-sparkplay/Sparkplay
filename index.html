<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#0B1220"/>
<title>SparkPlay â€“ Spazio</title>

<style>
:root{
  --bg1:#0B1220;
  --bg2:#101A33;
  --card:#16224A;
  --text:#EAF0FF;
  --muted:#9FB0FF;
  --accent:#4F7CFF;
  --ok:#2DCE89;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
  font-family:-apple-system,Inter,system-ui,sans-serif;
}

#app{
  min-height:100%;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

button{
  appearance:none;
  border:none;
  border-radius:14px;
  padding:14px;
  font-size:16px;
  font-weight:600;
  background:var(--accent);
  color:#fff;
}

button.secondary{
  background:rgba(255,255,255,.12);
}

.footer{
  margin-top:auto;
  text-align:center;
  font-size:13px;
  color:var(--muted);
}
</style>
</head>

<body>
<div id="app"></div>
<script>
(() => {
  "use strict";

  const KEY = "sparkplay_spazio_v2";
  const VERSION = "v2026.02.17-01";
  const todayStr = () => new Date().toDateString();
  const nowISO = () => new Date().toISOString();

  const DEFAULT = {
    date: todayStr(),
    missionsDone: 0,
    diary: [],
    current: null
  };

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      const s = raw ? JSON.parse(raw) : structuredClone(DEFAULT);
      // daily reset automatico
      if(s.date !== todayStr()){
        s.date = todayStr();
        s.missionsDone = 0;
        s.current = null;
      }
      // guardie anti-corruzione
      if(!Array.isArray(s.diary)) s.diary = [];
      if(typeof s.missionsDone !== "number") s.missionsDone = 0;
      return s;
    }catch(e){
      return structuredClone(DEFAULT);
    }
  }

  let state = load();

  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  // === Mission generator (Spazio) ===
  const MISSIONS = [
    { title:"Radar Spaziale", steps:[
      "Prendi una torcia e un oggetto metallico (cucchiaio).",
      "Fai â€˜scansioniâ€™ lente sul pavimento cercando â€˜segnaliâ€™.",
      "Disegna una mappa semplice di dove hai trovato il segnale."
    ]},
    { title:"Costruisci la Base", steps:[
      "Usa cuscini o scatole per creare una â€˜baseâ€™ a terra.",
      "Scegli 3 oggetti che saranno â€˜strumentiâ€™ della base.",
      "Spiega al genitore a cosa serve ogni strumento."
    ]},
    { title:"Respiro dellâ€™Astronauta", steps:[
      "Metti una mano sulla pancia e una sul petto.",
      "Inspira 3 secondi, espira 4 secondi (x4 volte).",
      "DÃ¬ una frase: â€˜Sono pronto per la missioneâ€™."
    ]},
    { title:"Allarme Meteora", steps:[
      "Trova 5 oggetti â€˜scudoâ€™ in casa (libro, coperchioâ€¦).",
      "Proteggi una zona sicura (la base).",
      "Racconta come hai salvato lâ€™equipaggio."
    ]},
  ];

  function pickMission(){
    const m = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
    return {
      id: "m_" + Math.random().toString(16).slice(2),
      createdAt: nowISO(),
      phase: 0, // 0 Calma, 1 Crea, 2 Esplora
      title: m.title,
      steps: m.steps
    };
  }

  const PHASES = [
    { key:"Calma", icon:"ðŸŒ™", hint:"30 secondi: respiro + focus." },
    { key:"Crea",  icon:"ðŸ§±", hint:"Costruisci / prepara con oggetti di casa." },
    { key:"Esplora", icon:"ðŸ›°ï¸", hint:"Azione: esegui e racconta la missione." }
  ];

  function startMission(){
    if(state.missionsDone >= 3) return;
    state.current = pickMission();
    save();
    render();
  }

  function nextPhase(){
    if(!state.current) return;
    if(state.current.phase < 2){
      state.current.phase++;
      save();
      render();
    }else{
      completeMission();
    }
  }

  function completeMission(){
    if(!state.current) return;

    state.missionsDone = Math.min(3, state.missionsDone + 1);

    state.diary.unshift({
      when: nowISO(),
      title: state.current.title,
      phases: PHASES.map(p=>p.key).join(" â†’ ")
    });

    state.current = null;
    save();
    render();
  }

  function resetTest(){
    // SOLO per test: reset immediato
    state.date = todayStr();
    state.missionsDone = 0;
    state.current = null;
    save();
    render();
  }

  // === UI ===
  function headerHTML(){
    return `
      <div class="header">
        <div>
          <strong>SparkPlay</strong><br/>
          <small class="muted">Montessori Â· Spazio</small>
        </div>
        <div class="badge">${VERSION}</div>
      </div>
    `;
  }

  function missionHomeHTML(){
    const locked = state.missionsDone >= 3;
    return `
      <div class="card">
        <h2>ðŸš€ Missione Spazio</h2>
        <p>Usa oggetti di casa per creare una missione spaziale.</p>
        <p><strong>Missioni fatte oggi:</strong> ${state.missionsDone}/3</p>

        ${
          !locked
          ? `<button onclick="SP.startMission()">Avvia missione</button>`
          : `<button class="secondary" disabled>Fine per oggi ðŸŒ™</button>`
        }

        <div style="height:10px"></div>
        <button class="secondary" onclick="SP.resetTest()">Nuova giornata (test)</button>
      </div>
    `;
  }

  function missionRunHTML(){
    const m = state.current;
    const p = PHASES[m.phase];
    return `
      <div class="card">
        <h2>${p.icon} ${p.key}</h2>
        <p style="color:var(--muted)">${p.hint}</p>

        <div style="height:10px"></div>
        <h3>${m.title}</h3>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px">
          ${m.steps.map(s => `
            <div style="background:rgba(255,255,255,.08); padding:12px; border-radius:14px">
              ${s}
            </div>
          `).join("")}
        </div>

        <div style="height:14px"></div>

        ${
          m.phase < 2
          ? `<button onclick="SP.nextPhase()">Avanti â†’</button>`
          : `<button onclick="SP.completeMission()">Missione completata âœ…</button>`
        }

        <div style="height:10px"></div>
        <button class="secondary" onclick="SP.backHome()">Esci missione</button>
      </div>
    `;
  }

  function diaryHTML(){
    const items = state.diary.slice(0,6);
    return `
      <div class="card">
        <h3>ðŸ“˜ Diario missioni</h3>
        <p style="color:var(--muted)">Piccolo storico delle missioni completate.</p>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px">
          ${
            items.length
            ? items.map(it => `
              <div style="background:rgba(255,255,255,.06); padding:12px; border-radius:14px">
                <strong>${it.title}</strong><br/>
                <small style="color:var(--muted)">${new Date(it.when).toLocaleString()}</small>
              </div>
            `).join("")
            : `<div style="color:var(--muted)">Ancora nessuna missione salvata.</div>`
          }
        </div>
      </div>
    `;
  }

  function footerHTML(){
    return `<div class="footer">Gioca meglio Â· Cresci meglio</div>`;
  }

  function render(){
    const root = document.getElementById("app");
    root.innerHTML =
      headerHTML() +
      (state.current ? missionRunHTML() : missionHomeHTML()) +
      diaryHTML() +
      footerHTML();
  }

  // API globale per i bottoni inline
  window.SP = {
    startMission,
    nextPhase,
    completeMission,
    resetTest,
    backHome: () => { state.current = null; save(); render(); }
  };

  render();
})();
</script>

</body>
</html>