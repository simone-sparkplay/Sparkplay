<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#071b3a" />
  <title>SparkPlay -- Spazio</title>

  <!-- ICONS (root) -->
  <link rel="icon" href="icona.png?v=3" />
  <link rel="apple-touch-icon" href="icona.png?v=3" />

  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#06142c;
      --bg2:#0a2a55;
      --bg3:#0c3f73;

      --glass: rgba(255,255,255,.12);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.18);

      --text: #f6f8ff;
      --muted: rgba(246,248,255,.72);

      --coral:#ff5e6c;
      --cyan:#00d2ff;
      --yellow:#ffe66d;

      --shadow: 0 18px 50px rgba(0,0,0,.28);
      --shadow2: 0 14px 34px rgba(0,0,0,.22);

      --radiusXL: 34px;
      --radiusL: 24px;
      --radiusM: 18px;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    /* ==== REMOVE WHITE BAR / SAFE AREA / OVERSCROLL ==== */
    html, body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 900px at 50% 25%, #1b6fb0 0%, #0b3a6b 26%, var(--bg2) 55%, var(--bg1) 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    body{
      font-family: Quicksand, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* App wrapper */
    .app{
      min-height: 100svh; /* iOS safe viewport */
      padding: calc(14px + var(--safeTop)) 14px calc(18px + var(--safeBottom));
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
    }

    /* Header */
    .topbar{
      width: min(760px, 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px;
    }
    .iconBtn{
      width:46px;height:46px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{ transform: translateY(1px); }

    .brand{
      text-align:center;
      line-height:1;
      user-select:none;
    }
    .brand .name{
      font-family: Fredoka, system-ui, sans-serif;
      font-size: 38px;
      letter-spacing: 1px;
      color: var(--yellow);
      text-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .brand .world{
      margin-top:6px;
      font-weight:700;
      letter-spacing: 4px;
      font-size: 14px;
      color: rgba(0,210,255,.95);
      text-transform: uppercase;
    }

    /* Screens */
    .screen{
      width: min(760px, 100%);
      display:none;
      flex: 1;
      align-items:center;
      justify-content:center;
    }
    .screen.active{ display:flex; }

    /* Main card */
    .glassCard{
      width: min(560px, 100%);
      border-radius: var(--radiusXL);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      box-shadow: var(--shadow);
      padding: 18px;
      box-sizing:border-box;
      position:relative;
    }

    /* Home hero */
    .heroFrame{
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(800px 520px at 50% 30%, rgba(0,210,255,.18), rgba(255,255,255,.04));
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .heroImgWrap{
      border-radius: 24px;
      overflow:hidden;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(255,255,255,.14);
    }
    .heroImg{
      width:100%;
      height:auto;
      display:block;
      /* prevents weird stretching on some browsers */
      image-rendering: auto;
    }

    .bigTitle{
      margin: 16px 0 12px;
      font-family: Fredoka, system-ui, sans-serif;
      font-size: 64px;
      letter-spacing: 1px;
      text-align:center;
      color: var(--yellow);
      text-shadow: 0 10px 22px rgba(0,0,0,.30);
    }

    .primaryBtn{
      width:100%;
      border:none;
      border-radius: 28px;
      padding: 18px 18px;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 1px;
      color: white;
      background: linear-gradient(180deg, #ff6f7c, var(--coral));
      box-shadow: 0 16px 28px rgba(255,94,108,.25), 0 14px 34px rgba(0,0,0,.20);
      cursor:pointer;
    }
    .primaryBtn:active{ transform: translateY(1px); }

    .chips{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .chip{
      min-width: 140px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(246,248,255,.92);
      font-weight:800;
      letter-spacing:1px;
      text-align:center;
    }

    /* Mission */
    .missionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .missionTitle{
      font-family: Fredoka, system-ui, sans-serif;
      font-size: 30px;
      margin:0;
      color: var(--yellow);
    }
    .audioToggle{
      width:44px;height:44px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }

    .objective{
      margin: 10px 0 14px;
      border-radius: 18px;
      border: 2px dashed rgba(0,210,255,.85);
      background: rgba(0,210,255,.08);
      padding: 12px 14px;
      text-align:center;
    }
    .objective .label{
      font-weight:900;
      letter-spacing: 4px;
      font-size: 14px;
      color: rgba(0,210,255,.95);
      margin-bottom: 6px;
      text-transform: uppercase;
    }
    .objective .text{
      margin:0;
      font-size: 20px;
      font-weight:800;
    }

    .step{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      margin-bottom: 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
    }
    .num{
      width:36px;height:36px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight:900;
      color:white;
      background: linear-gradient(180deg, #ff6f7c, var(--coral));
      flex: 0 0 auto;
    }
    .step p{
      margin:0;
      font-size: 20px;
      font-weight:700;
      color: rgba(246,248,255,.92);
    }

    .navRow{
      display:flex;
      gap: 12px;
      margin-top: 12px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .secondaryBtn{
      flex:1;
      min-width: 170px;
      border:none;
      border-radius: 22px;
      padding: 14px 16px;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 1px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(246,248,255,.92);
      cursor:pointer;
    }
    .secondaryBtn:active{ transform: translateY(1px); }
    .nextBtn{
      flex:1.2;
      min-width: 200px;
      border:none;
      border-radius: 22px;
      padding: 14px 16px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: 1px;
      background: linear-gradient(180deg, rgba(0,210,255,.95), rgba(0,160,210,.95));
      color: #062038;
      cursor:pointer;
      box-shadow: 0 16px 28px rgba(0,210,255,.18);
    }

    /* Diary */
    .diaryTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .diaryTitle{
      margin:0;
      font-family: Fredoka, system-ui, sans-serif;
      font-size: 44px;
      letter-spacing: 1px;
    }
    .diarySub{
      margin:6px 0 0;
      font-weight:900;
      letter-spacing: 6px;
      font-size: 14px;
      color: rgba(0,210,255,.90);
      text-transform: uppercase;
    }
    .closeX{
      width:54px;height:54px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, #ff6f7c, var(--coral));
      color:white;
      display:grid;
      place-items:center;
      font-size: 22px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 14px 24px rgba(255,94,108,.20);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 12px;
      max-height: min(66svh, 520px);
      overflow:auto;
      padding-right: 6px;
    }
    .list::-webkit-scrollbar{ width:8px; }
    .list::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; }

    .entry{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
    }
    .entryLeft{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .bookIcon{
      width:42px;height:42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      display:grid;
      place-items:center;
      font-size: 22px;
      flex:0 0 auto;
    }
    .entryText{
      min-width:0;
    }
    .entryText .t{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .entryText .d{
      margin:4px 0 0;
      font-size: 16px;
      color: rgba(246,248,255,.70);
      font-weight:800;
    }
    .badge{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(0,210,255,.90);
      font-weight: 1000;
      letter-spacing: 1px;
      flex: 0 0 auto;
      min-width: 64px;
      text-align:center;
    }

    /* Utility */
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="iconBtn" id="btnDiary" title="Diario">ðŸ“š</div>

      <div class="brand">
        <div class="name">SPARKPLAY</div>
        <div class="world">SPAZIO</div>
      </div>

      <div class="iconBtn" id="btnAudioTop" title="Audio ON/OFF">ðŸ”Š</div>
    </div>

    <!-- HOME -->
    <section class="screen active" id="screenHome">
      <div class="glassCard">
        <div class="heroFrame">
          <div class="heroImgWrap">
            <!-- HOME HERO (root) -->
            <img class="heroImg" src="home-hero.png?v=3" alt="" />
          </div>
        </div>

        <div class="bigTitle">PRONTI?</div>

        <button class="primaryBtn" id="btnStart">AVVIA MISSIONE</button>

        <div class="chips">
          <div class="chip" id="chipToday">OGGI: 0/3</div>
          <div class="chip" id="chipAge">ETÃ€: --</div>
        </div>
      </div>
    </section>

    <!-- MISSION -->
    <section class="screen" id="screenMission">
      <div class="glassCard">
        <div class="missionHead">
          <h2 class="missionTitle" id="missionTitle">Missione</h2>
          <div class="audioToggle" id="btnAudioMission" title="Audio ON/OFF">ðŸ”Š</div>
        </div>

        <div class="objective">
          <div class="label">OBIETTIVO</div>
          <p class="text" id="objectiveText">--</p>
        </div>

        <div class="step" id="stepBox">
          <div class="num" id="stepNum">1</div>
          <p id="stepText">--</p>
        </div>

        <div class="navRow">
          <button class="secondaryBtn" id="btnPrev">INDIETRO</button>
          <button class="nextBtn" id="btnNext">AVANTI</button>
        </div>
      </div>
    </section>

    <!-- DIARY -->
    <section class="screen" id="screenDiary">
      <div class="glassCard">
        <div class="diaryTop">
          <div>
            <h1 class="diaryTitle">DIARIO <span style="font-size:28px;">ðŸ“š</span></h1>
            <div class="diarySub">I TUOI RICORDI</div>
          </div>
          <div class="closeX" id="btnCloseDiary">âœ•</div>
        </div>

        <div class="list" id="diaryList"></div>
      </div>
    </section>
  </div>

  <script>
    /* =========================
       STATE + DATA (SPACE)
       ========================= */
    const state = {
      audioOn: true,
      age: null,          // "5-7" | "8-10"
      todayDone: 0,
      todayMax: 3,
      missionIndex: 0,    // current mission
      stepIndex: 0,
      diary: []
    };

    // Minimal dataset (tu puoi sostituire/estendere senza toccare la logica)
    const missions = [
      {
        title: "Polvere di Stelle",
        age: "5-7",
        objective: "Pulisci i pannelli solari.",
        steps: [
          "Prendi un calzino o un panno morbido.",
          "Pulisci tre superfici diverse nella stanza.",
          "Soffia forte su ogni punto pulito!"
        ]
      },
      {
        title: "Antenna Spaziale",
        age: "5-7",
        objective: "Costruisci una super antenna.",
        steps: [
          "Prendi un cucchiaio o una matita.",
          "Fingi che sia lâ€™antenna e punta verso una finestra.",
          "Invia un messaggio segreto con la voce: "Pronto pianeta Terra!""
        ]
      },
      {
        title: "GravitÃ  Zero",
        age: "8-10",
        objective: "Allena lâ€™equilibrio da astronauta.",
        steps: [
          "Cammina lentamente in linea retta come se fossi sulla Luna.",
          "Fai 5 passi senza far rumore.",
          "Ora fai 3 salti piccoli e atterra morbido."
        ]
      }
    ];

    /* =========================
       DOM
       ========================= */
    const $ = (id) => document.getElementById(id);

    const screenHome = $("screenHome");
    const screenMission = $("screenMission");
    const screenDiary = $("screenDiary");

    const chipToday = $("chipToday");
    const chipAge = $("chipAge");

    const btnStart = $("btnStart");
    const btnPrev = $("btnPrev");
    const btnNext = $("btnNext");

    const btnDiary = $("btnDiary");
    const btnCloseDiary = $("btnCloseDiary");

    const btnAudioTop = $("btnAudioTop");
    const btnAudioMission = $("btnAudioMission");

    const missionTitle = $("missionTitle");
    const objectiveText = $("objectiveText");
    const stepNum = $("stepNum");
    const stepText = $("stepText");
    const diaryList = $("diaryList");

    /* =========================
       HELPERS: Screens
       ========================= */
    function showScreen(screenEl){
      [screenHome, screenMission, screenDiary].forEach(s => s.classList.remove("active"));
      screenEl.classList.add("active");
      // stop any ongoing speech when switching screens
      stopSpeech();
    }

    /* =========================
       AUDIO (SpeechSynthesis) - BUG FIXED
       ========================= */
    function stopSpeech(){
      try{
        window.speechSynthesis.cancel();
      }catch(e){}
    }

    function getRateForAge(){
      // piÃ¹ lento per bambini piccoli
      if(state.age === "5-7") return 0.82;   // lento e chiaro
      if(state.age === "8-10") return 0.92;  // leggermente piÃ¹ veloce
      return 0.88;
    }

    function speak(text){
      if(!state.audioOn) return;
      if(!text) return;

      stopSpeech(); // IMPORTANT: prevents half-sentences / overlap

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "it-IT";
      u.rate = getRateForAge();
      u.pitch = 1.05;
      u.volume = 1;

      // pick best italian voice if available
      const voices = window.speechSynthesis.getVoices?.() || [];
      const it = voices.find(v => (v.lang || "").toLowerCase().startsWith("it")) || null;
      if(it) u.voice = it;

      window.speechSynthesis.speak(u);
    }

    function toggleAudio(){
      state.audioOn = !state.audioOn;
      const icon = state.audioOn ? "ðŸ”Š" : "ðŸ”‡";
      btnAudioTop.textContent = icon;
      btnAudioMission.textContent = icon;
      if(!state.audioOn) stopSpeech();
      // if audio turned ON while in mission, re-read current step
      if(state.audioOn && screenMission.classList.contains("active")){
        speak(getCurrentStepTextFull());
      }
    }

    /* Some browsers load voices async */
    window.speechSynthesis.onvoiceschanged = () => {};

    /* =========================
       GAME LOGIC
       ========================= */
    function updateChips(){
      chipToday.textContent = `OGGI: ${state.todayDone}/${state.todayMax}`;
      chipAge.textContent = `ETÃ€: ${state.age ? state.age : "--"}`;
    }

    function pickNextMission(){
      // semplice rotazione; puoi sostituire con algoritmo piÃ¹ smart
      const m = missions[state.missionIndex % missions.length];
      state.missionIndex = (state.missionIndex + 1) % missions.length;
      state.stepIndex = 0;
      state.age = m.age;
      return m;
    }

    let currentMission = null;

    function getCurrentStepTextFull(){
      if(!currentMission) return "";
      const s = currentMission.steps[state.stepIndex] || "";
      // testo letto: titolo + obiettivo + step corrente
      return `${currentMission.title}. Obiettivo: ${currentMission.objective}. Passo ${state.stepIndex + 1}. ${s}`;
    }

    function renderMission(){
      missionTitle.textContent = currentMission.title;
      objectiveText.textContent = currentMission.objective;

      const n = state.stepIndex + 1;
      stepNum.textContent = String(n);
      stepText.textContent = currentMission.steps[state.stepIndex] || "";

      btnPrev.disabled = (state.stepIndex === 0);
      btnPrev.style.opacity = btnPrev.disabled ? 0.5 : 1;

      // speak full, always from start (no half bug)
      speak(getCurrentStepTextFull());
    }

    function completeMission(){
      // save to diary
      const today = new Date();
      const dd = String(today.getDate()).padStart(2, "0");
      const mm = String(today.getMonth()+1).padStart(2, "0");
      const yyyy = String(today.getFullYear());

      state.diary.unshift({
        title: currentMission.title,
        date: `${dd}/${mm}/${yyyy}`,
        age: currentMission.age
      });

      state.todayDone = Math.min(state.todayMax, state.todayDone + 1);
      updateChips();
      renderDiary();
      showScreen(screenHome);
      stopSpeech();
    }

    /* =========================
       DIARY
       ========================= */
    function renderDiary(){
      diaryList.innerHTML = "";
      if(state.diary.length === 0){
        const empty = document.createElement("div");
        empty.style.opacity = "0.8";
        empty.style.fontWeight = "900";
        empty.style.textAlign = "center";
        empty.style.padding = "16px";
        empty.textContent = "Ancora nessuna missione salvata.";
        diaryList.appendChild(empty);
        return;
      }

      state.diary.forEach(item => {
        const row = document.createElement("div");
        row.className = "entry";

        const left = document.createElement("div");
        left.className = "entryLeft";

        // ONLY diary icon for every entry (as requested)
        const ic = document.createElement("div");
        ic.className = "bookIcon";
        ic.textContent = "ðŸ“—";

        const txt = document.createElement("div");
        txt.className = "entryText";

        const t = document.createElement("p");
        t.className = "t";
        t.textContent = item.title;

        const d = document.createElement("p");
        d.className = "d";
        d.textContent = item.date;

        txt.appendChild(t);
        txt.appendChild(d);

        left.appendChild(ic);
        left.appendChild(txt);

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = item.age;

        row.appendChild(left);
        row.appendChild(badge);

        diaryList.appendChild(row);
      });
    }

    /* =========================
       EVENTS
       ========================= */
    btnStart.addEventListener("click", () => {
      if(state.todayDone >= state.todayMax){
        // simple end-of-day message (premium: no extra screen)
        speak("Hai giÃ  completato le missioni di oggi! Torna domani per nuove avventure.");
        return;
      }
      currentMission = pickNextMission();
      updateChips();
      showScreen(screenMission);
      renderMission();
    });

    btnPrev.addEventListener("click", () => {
      if(!currentMission) return;
      if(state.stepIndex > 0){
        state.stepIndex--;
        renderMission(); // will cancel+re-read
      }
    });

    btnNext.addEventListener("click", () => {
      if(!currentMission) return;
      const last = currentMission.steps.length - 1;
      if(state.stepIndex < last){
        state.stepIndex++;
        renderMission(); // will cancel+re-read
      }else{
        // completed
        speak("Missione completata! Bravo astronauta.");
        setTimeout(() => completeMission(), 250);
      }
    });

    btnDiary.addEventListener("click", () => {
      renderDiary();
      showScreen(screenDiary);
    });

    btnCloseDiary.addEventListener("click", () => {
      showScreen(screenHome);
    });

    btnAudioTop.addEventListener("click", toggleAudio);
    btnAudioMission.addEventListener("click", toggleAudio);

    // initial
    updateChips();
    renderDiary();

    // Extra iOS: prevent accidental bounce creating white gaps
    document.addEventListener("touchmove", (e) => {
      // allow scrolling only in diary list
      const path = e.composedPath ? e.composedPath() : [];
      const inDiaryList = path.some(el => el && el.id === "diaryList");
      if(!inDiaryList) e.preventDefault();
    }, { passive: false });

  </script>
</body>
</html>