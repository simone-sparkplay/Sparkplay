<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SparkPlay</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
:root {
  --rossa: #ff5e6c; --blu: #00d2ff; --giallo: #ffe66d;
  --sfondo: #3a47d5; --latte: #f7fff7;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; padding: 0; background-color: var(--sfondo); font-family: 'Quicksand', sans-serif; 
  color: var(--latte); height: 100vh; width: 100vw; overflow: hidden;
  background-image: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #764ba2 100%);
}
.sp-root { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom); position: relative; overflow-x: hidden; }
.multiverso-container { width: 100%; height: 180px; margin: 10px 0; position: relative; display: flex; align-items: center; justify-content: center; }
.icona-mondo { position: absolute; font-size: 50px; animation: orbitaMondi 8s linear infinite; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
.mondo-1 { animation-delay: 0s; }
.mondo-2 { animation-delay: -2.66s; }
.mondo-3 { animation-delay: -5.33s; }
@keyframes orbitaMondi { from { transform: rotate(0deg) translateX(75px) rotate(0deg); } to { transform: rotate(360deg) translateX(75px) rotate(-360deg); } }
.centro-spark { width: 70px; height: 70px; background: white; border-radius: 50%; box-shadow: 0 0 40px var(--giallo), 0 0 10px white; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 35px; }
.sp-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
.brand { font-family: 'Fredoka One', cursive; font-size: 36px; color: var(--giallo); text-shadow: 3px 3px var(--rossa); }
.content-area { flex: 1; display: flex; flex-direction: column; gap: 15px; justify-content: center; align-items: center; width: 100%; }
.testo-storia { font-size: 20px; line-height: 1.4; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.obiettivo-box { border: 3px dashed var(--blu); border-radius: 25px; padding: 15px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.2); width: 100%; }
.passo { padding: 18px; border-radius: 25px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; font-weight: 700; width: 100%; transition: 0.3s; }
.passo.attivo { background: var(--latte); color: var(--sfondo); transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
.btn { border: none; font-family: 'Fredoka One', cursive; cursor: pointer; transition: 0.2s; border-radius: 25px; }
.btn-avanti { background: var(--rossa); color: white; padding: 20px; width: 100%; font-size: 22px; box-shadow: 0 6px 0 #c43d4a; }
#overlay-success { position: fixed; inset: 0; pointer-events: none; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; background: rgba(0, 0, 0, 0.8); }
.messaggio-vittoria { font-family: 'Fredoka One'; font-size: 44px; color: var(--giallo); text-shadow: 4px 4px var(--rossa); text-align: center; }
</style>
</head>
<body>
<div id="overlay-success"><div class="messaggio-vittoria">MISSIONE<br>COMPLETATA!</div></div>
<div id="SPARKPLAY_APP" class="sp-root"></div>

<script>
(()=>{"use strict";

const DB = {
  "5-7": [
    {t:"SEGNALE PERDUTO", s:"La base ha perso il segnale! La galassia √® al buio!", o:"RIACCENDI L'ANTENNA!", p:["Trova un calzino stellare.","Portalo sulla base, sopra il tappeto.","D√¨ tre volte: Bip! Bip! Bip!"]},
    {t:"SATELLITE MORBIDO", s:"Un satellite √® caduto tra le stelle!", o:"RECUPERALO!", p:["Trova un peluche-satellite.","Fagli fare un giro intorno al tavolo.","Mettilo a riposare in un posto alto."]}
  ],
  "8-10": [
    {t:"MODULO VIBRANTE", s:"Il modulo quattro vibra forte. Serve silenzio assoluto!", o:"RIPARA IN SILENZIO", p:["Trova un foglio di carta.","Portalo alla base senza fare rumore.","Piegalo in quattro e mettilo sotto un cuscino."]}
  ]
};

let s = { fsm:"INIZIO", eta:null, passo:0, missioniFatte:0, missioneAttuale:null, audio:true };

function parla(testo, alTermine){
  if(!s.audio) { if(alTermine) alTermine(); return; }
  speechSynthesis.cancel();
  const m = new SpeechSynthesisUtterance(testo);
  m.lang="it-IT"; m.rate=0.9; m.pitch=1.1; // Voce leggermente pi√π amichevole
  if(alTermine) m.onend = alTermine;
  speechSynthesis.speak(m);
}

function disegna(){
  const root = document.getElementById("SPARKPLAY_APP");
  if(s.fsm === "INIZIO"){
    root.innerHTML = `<div class="sp-top"><div></div><div class="brand">SPARKPLAY</div><button class="btn" style="background:none;font-size:32px;" onclick="toggleAudio()">${s.audio?'üîä':'üîà'}</button></div>
      <div class="content-area"><div class="multiverso-container"><div class="centro-spark">‚ú®</div><div class="icona-mondo mondo-1">üöÄ</div><div class="icona-mondo mondo-2">ü™Ñ</div><div class="icona-mondo mondo-3">üîç</div></div><h1 style="color:var(--giallo);font-size:52px;margin:10px 0;">PRONTI?</h1><button class="btn btn-avanti" style="width:90%;" onclick="vaiEta()">INIZIA MISSIONE</button></div>`;
  } 
  else if(s.fsm === "ETA"){
    root.innerHTML = `<div class="sp-top"><div class="brand">CHI SEI?</div></div><div class="content-area">
        <button class="btn" style="background:rgba(255,255,255,0.2); border:3px solid var(--blu); color:white; padding:25px; font-size:22px; width:100%; display:flex; align-items:center; justify-content:space-between;" onclick="scegliEta('5-7')"><span>üöÄ</span><div><b>ESPLORATORE</b><br><small>5-7 ANNI</small></div></button>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:3px solid var(--rossa); color:white; padding:25px; font-size:22px; width:100%; display:flex; align-items:center; justify-content:space-between;" onclick="scegliEta('8-10')"><span>üß†</span><div><b>COMANDANTE</b><br><small>8-10 ANNI</small></div></button></div>`;
  }
  else if(s.fsm === "GIOCO"){
    const m = s.missioneAttuale;
    root.innerHTML = `<div class="sp-top"><button class="btn" style="background:none;font-size:32px;" onclick="toggleAudio()">${s.audio?'üîä':'üîà'}</button><div class="brand" style="font-size:20px">${m.t}</div><button class="btn" style="background:rgba(255,255,255,0.1);color:white;padding:8px 15px;border-radius:15px;" onclick="s.fsm='INIZIO';disegna();">ESCI</button></div>
      <div class="content-area"><div class="testo-storia">${m.s}</div><div class="obiettivo-box">OBIETTIVO: ${m.o}</div><div style="width:100%">${m.p.map((t,i)=>`<div class="passo ${i===s.passo?'attivo':(i<s.passo?'':'sfumato')}"><div style="background:var(--rossa);color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:10px;">${i+1}</div>${t}</div>`).join('')}</div>
        <div style="display:flex;gap:15px;width:100%;"><button class="btn" style="background:rgba(255,255,255,0.1);color:white;flex:1;padding:15px;" onclick="precedente()" ${s.passo===0?'style="visibility:hidden"':''}>INDIETRO</button><button class="btn btn-avanti" style="flex:2;" onclick="successivo()">${s.passo < m.p.length-1 ? 'AVANTI' : 'COMPLETA ‚úÖ'}</button></div></div>`;
  }
}

window.toggleAudio = () => { s.audio = !s.audio; disegna(); };
window.vaiEta = () => { s.fsm = "ETA"; disegna(); };
window.scegliEta = (e) => { s.eta = e; s.missioniFatte = 0; s.fsm = "GIOCO"; proproxima(); };

function proproxima(){
  if(s.missioniFatte < DB[s.eta].length){
    s.missioneAttuale = DB[s.eta][s.missioniFatte]; s.passo = 0; s.fsm = "GIOCO"; disegna();
    // Legge Storia + Obiettivo + In automatico il Punto 1
    parla(s.missioneAttuale.s + ". L'obiettivo √®: " + s.missioneAttuale.o + ". Primo passaggio: " + s.missioneAttuale.p[0]);
  } else { s.fsm = "INIZIO"; disegna(); }
}

window.successivo = () => {
  if(s.passo < s.missioneAttuale.p.length - 1){ 
    s.passo++; disegna(); 
    parla("Ottimo! Prossimo passaggio: " + s.missioneAttuale.p[s.passo]); 
  } else {
    document.getElementById("overlay-success").style.display = "flex";
    parla("Missione completata! Bravissimo pilota!"); // Annuncio vocale vittoria
    setTimeout(() => { 
        document.getElementById("overlay-success").style.display = "none";
        s.missioniFatte++; proproxima(); 
    }, 3000);
  }
};

window.precedente = () => { if(s.passo > 0){ s.passo--; disegna(); parla(s.missioneAttuale.p[s.passo]); } };

disegna();
})();
</script>
</body>
</html>
