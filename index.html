<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SparkPlay -- Spazio</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --coral:#ff5e6c;
      --cyan:#00d2ff;
      --yellow:#ffe66d;
      --bg:#0a1128;
      --white:#f7fff7;
      --glass:rgba(255,255,255,.10);
      --glass2:rgba(255,255,255,.14);
      --stroke:rgba(255,255,255,.12);
      --safe-top:env(safe-area-inset-top);
      --safe-bottom:env(safe-area-inset-bottom);

      /* Ombre: pi√π premium, meno "giocattolo" */
      --depth: 0 10px 30px rgba(0,0,0,.30);
      --btnDepth: 0 12px 30px rgba(0,0,0,.22);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{
      margin:0;padding:0;
      background: radial-gradient(circle at 50% 45%, #1a2a5a 0%, #0a1128 55%, #070d20 100%);
      font-family:'Quicksand',sans-serif;color:var(--white);
      height:100vh;overflow:hidden;
    }

    header{
      position:fixed;top:0;left:0;right:0;
      height: calc(70px + var(--safe-top));
      padding-top: var(--safe-top);
      display:flex;align-items:center;justify-content:space-between;
      padding-left:20px;padding-right:20px;
      background: rgba(10,17,40,.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      z-index: 100;
      border-bottom: 1px solid var(--stroke);
    }

    .brand-group{text-align:center;flex:1;pointer-events:none}
    .brand{
      font-family:'Fredoka One',cursive;
      font-size:24px;color:var(--yellow);
      text-shadow:2px 2px var(--coral);margin:0;
      letter-spacing:.5px;
    }
    .sub-brand{font-size:13px;font-weight:800;color:var(--cyan);letter-spacing:2px;text-transform:uppercase}

    .btn-header{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      width:46px;height:46px;
      color:#fff;font-size:22px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .btn-header:active{transform:scale(.98)}

    /* Container principale */
    #main-container{
      margin-top: calc(80px + var(--safe-top));
      height: calc(100vh - 80px - var(--safe-top));
      padding: 18px 18px calc(18px + var(--safe-bottom));
      display:flex;flex-direction:column;align-items:center;
      overflow:hidden;
    }

    .screen{
      display:none;width:100%;max-width:520px;
      height:100%;
      flex-direction:column;align-items:center;
      justify-content:center;
    }
    .screen.active{display:flex;animation: fadeIn .35s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .glass-card{
      width:100%;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 30px;
      box-shadow: var(--depth);
      padding: 18px;
      text-align:center;
    }

    /* HOME orbit - centrato perfetto */
    .multiverso-wrap{
      width: 220px; height: 220px;
      position: relative;
      margin: 0 auto 18px;
      display:flex;align-items:center;justify-content:center;
      transform: translateX(0); /* forza centratura */
    }
    .orbit-icon{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      font-size: 46px;
      animation: orbit 10s linear infinite;
      transform-origin: center;
      will-change: transform;
    }
    .o1{animation-delay:0s}
    .o2{animation-delay:-3.3s}
    .o3{animation-delay:-6.6s}

    .center-spark{
      width: 64px; height: 64px;
      background:#fff;border-radius:50%;
      box-shadow: 0 0 34px rgba(255,230,109,.55);
      z-index:2;
      display:flex;align-items:center;justify-content:center;
      font-size:30px;
    }
    @keyframes orbit{
      from{transform: translate(-50%,-50%) rotate(0deg) translateX(92px) rotate(0deg)}
      to{transform: translate(-50%,-50%) rotate(360deg) translateX(92px) rotate(-360deg)}
    }

    /* Bottoni: stessi colori, ombre soft */
    .btn-big{
      border:none;border-radius:24px;
      padding: 18px 22px;
      width:100%;
      font-family:'Fredoka One',cursive;
      font-size: 24px;
      cursor:pointer;
      color:#fff;
      background: var(--coral);
      box-shadow: var(--btnDepth);
      transition: transform .08s ease;
    }
    .btn-big:active{transform: scale(.99)}
    .btn-cyan{background: var(--cyan)}
    .btn-yellow{background: var(--yellow); color: var(--bg)}
    .btn-muted{background:#4a5568;color:#fff}

    /* Chip */
    .chip-row{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .chip{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      padding: 8px 14px;border-radius:18px;
      font-size:13px;font-weight:800;
      min-width:110px;
    }

    /* GIOCO: layout "tutto sott‚Äôocchio" */
    #screen-gioco{
      justify-content:flex-start;
    }
    .mission-card{
      width:100%;
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius:30px;
      box-shadow: var(--depth);
      padding: 14px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:10px;
      height: 100%;
      max-height: 640px; /* aiuta a non tagliare su iPhone */
    }

    .mission-topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .mini-pill{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:14px;
      font-size:12px;font-weight:900;
      color:#eaf2ff;
    }
    .btn-link{
      background:none;border:none;
      color:#eaf2ff;opacity:.85;
      font-weight:800;
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn-link:active{transform:scale(.99)}

    .mission-title{
      font-family:'Fredoka One',cursive;
      font-size: 22px;
      color: var(--yellow);
      margin: 0;
      text-align:center;
    }
    .mission-story{
      font-size: 16px; line-height: 1.35;
      color: #cbd5e1;
      margin: 0;
      text-align:center;
    }
    .objective-box{
      background: rgba(0,210,255,.10);
      border: 2px dashed var(--cyan);
      border-radius: 18px;
      padding: 12px;
      text-align:center;
    }
    .objective-box b{
      display:block;
      color: var(--cyan);
      letter-spacing:2px;
      margin-bottom:6px;
      text-transform:uppercase;
      font-size: 13px;
    }

    .steps-wrap{
      display:flex;flex-direction:column;
      gap:10px;
      flex: 1;
      min-height: 0;
    }
    .step{
      display:flex;gap:12px;align-items:center;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      opacity: .30;
      transition:.25s;
    }
    .step.active{
      opacity:1;
      background: rgba(255,255,255,.14);
      border: 2px solid rgba(255,230,109,.75);
      transform: scale(1.01);
    }
    .step-num{
      width:32px;height:32px;border-radius:50%;
      background: var(--coral);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      flex-shrink:0;
    }

    /* Controlli in basso: sempre visibili, non tagliati */
    .game-controls{
      display:flex;gap:12px;
      width:100%;
    }
    .btn-ctrl{
      flex:1;
      padding: 14px 14px;
      border-radius: 18px;
      border:none;
      font-family:'Fredoka One',cursive;
      font-size: 18px;
      cursor:pointer;
      color:#fff;
      box-shadow: none; /* niente ombra qui */
    }

    /* Overlay complete */
    #overlay-complete{
      position:fixed;inset:0;
      background: rgba(10,17,40,.92);
      z-index:1000;
      display:none;
      align-items:center;justify-content:center;
      flex-direction:column;
      text-align:center;
      padding:30px;
    }

    /* Diario: pi√π brio */
    #overlay-diario{
      position:fixed;inset:0;
      background: radial-gradient(circle at 50% 20%, rgba(0,210,255,.10), transparent 40%),
                  radial-gradient(circle at 20% 90%, rgba(255,94,108,.10), transparent 40%),
                  var(--bg);
      z-index:2000;
      display:none;
      flex-direction:column;
      padding: calc(var(--safe-top) + 18px) 18px calc(18px + var(--safe-bottom));
      overflow:hidden;
    }
    .diary-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:14px;
    }
    .diary-title{
      font-family:'Fredoka One',cursive;
      font-size:32px;
      margin:0;
      color: var(--white);
      letter-spacing:1px;
    }
    .diary-sub{
      font-weight:800;
      color: var(--cyan);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size: 12px;
      margin-top:4px;
    }
    .diary-list{
      flex:1;overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-right:4px;
    }
    .diary-entry{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      padding: 14px 14px;
      border-radius: 22px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
    }
    .diary-entry:before{
      content:"";
      position:absolute;left:0;top:0;bottom:0;
      width:8px;border-radius:22px 0 0 22px;
      background: linear-gradient(180deg, var(--cyan), rgba(255,94,108,.8));
      opacity:.9;
    }
    .diary-left{
      display:flex;align-items:center;gap:12px;
      padding-left:6px;
      min-width:0;
    }
    .diary-emoji{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      flex-shrink:0;
      font-size:22px;
    }
    .diary-text{
      min-width:0;
    }
    .diary-text b{
      display:block;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .diary-text small{
      opacity:.75;
      font-weight:800;
    }
    .diary-meta{
      font-size:12px;
      color: var(--cyan);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1px;
      flex-shrink:0;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Parent gate */
    #parent-gate{
      position:fixed;inset:0;
      background: rgba(0,0,0,.82);
      z-index:3000;
      display:none;
      align-items:center;justify-content:center;
      padding: 20px;
    }
    .gate-box{
      width:100%;max-width:340px;
      background:#1e293b;
      border-radius: 30px;
      border: 2px solid var(--cyan);
      padding: 22px;
      text-align:center;
      box-shadow: var(--depth);
    }
    .gate-box h3{
      font-family:'Fredoka One',cursive;
      color: var(--cyan);
      margin: 0 0 6px;
      letter-spacing:1px;
    }
    .gate-box p{margin:0 0 14px;opacity:.9;font-weight:800}
    .gate-box input{
      width:100%;
      padding: 16px;
      border-radius: 16px;
      border:none;
      margin: 10px 0 16px;
      font-size: 28px;
      text-align:center;
      background:#0f172a;color:#fff;
      -webkit-appearance:none;
    }
    .gate-actions{display:flex;gap:12px}
    .gate-actions button{flex:1}

    /* Genitore: evita "spezzato" e overflow */
    #screen-genitore{justify-content:center}
    .trophy{font-size:64px;margin-bottom:8px}
    .gen-text{opacity:.85;margin: 6px 0 18px;font-weight:800}
  </style>
</head>
<body>

<header>
  <button class="btn-header" onclick="spark.openDiary()">üìö</button>
  <div class="brand-group">
    <h1 class="brand">SPARKPLAY</h1>
    <div class="sub-brand">Spazio</div>
  </div>
  <button class="btn-header" id="audioBtn" onclick="spark.toggleAudio()">üîä</button>
</header>

<div id="main-container">

  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="glass-card">
      <div class="multiverso-wrap">
        <div class="center-spark">‚ú®</div>
        <div class="orbit-icon o1">üöÄ</div>
        <div class="orbit-icon o2">ü™Ñ</div>
        <div class="orbit-icon o3">üîç</div>
      </div>
      <h2 style="font-family:'Fredoka One',cursive;font-size:50px;margin:0 0 18px;color:var(--yellow);">PRONTI?</h2>
      <button class="btn-big" onclick="spark.goToEta()">AVVIA MISSIONE</button>
      <div class="chip-row">
        <div class="chip" id="chip-today">OGGI: 0/3</div>
        <div class="chip" id="chip-eta">ET√Ä: --</div>
      </div>
    </div>
  </section>

  <!-- ETA -->
  <section id="screen-eta" class="screen">
    <div class="glass-card">
      <h2 style="font-family:'Fredoka One',cursive;font-size:28px;margin:0 0 18px;color:var(--yellow);">Quanti anni hai?</h2>
      <button class="btn-big" onclick="spark.selectEta('5-7')">5 - 7 ANNI</button>
      <div style="height:12px"></div>
      <button class="btn-big btn-cyan" onclick="spark.selectEta('8-10')">8 - 10 ANNI</button>
      <button class="btn-link" style="margin-top:10px" onclick="spark.showScreen('home')">Indietro</button>
    </div>
  </section>

  <!-- GIOCO -->
  <section id="screen-gioco" class="screen">
    <div class="mission-card">
      <div class="mission-topbar">
        <span class="mini-pill" id="pill-eta">ET√Ä: --</span>
        <button class="btn-link" onclick="spark.showScreen('eta')">‚üµ Indietro</button>
      </div>

      <h2 class="mission-title" id="mission-title"></h2>
      <p class="mission-story" id="mission-story"></p>

      <div class="objective-box" id="mission-goal"></div>

      <div class="steps-wrap" id="mission-steps"></div>

      <div class="game-controls">
        <button id="btn-back" class="btn-ctrl" style="background:#4a5568;" onclick="spark.prevStep()">INDIETRO</button>
        <button id="btn-next" class="btn-ctrl" style="background:var(--coral);" onclick="spark.nextStep()">AVANTI</button>
      </div>
    </div>
  </section>

  <!-- GENITORE -->
  <section id="screen-genitore" class="screen">
    <div class="glass-card">
      <div class="trophy">üèÜ</div>
      <h2 style="font-family:'Fredoka One',cursive;font-size:32px;color:var(--yellow);margin:0;">CAPITOLO FINITO!</h2>
      <div class="gen-text">Hai completato le missioni di oggi!</div>

      <button class="btn-big btn-yellow" id="btn-special" onclick="spark.askParent('spec')">MISSIONE SPECIALE ü§ù</button>
      <div style="height:12px"></div>
      <button class="btn-big btn-cyan" onclick="spark.askParent('more')">FAI ALTRE 3 MISSIONI üöÄ</button>
      <div style="height:12px"></div>
      <button class="btn-big btn-muted" onclick="spark.finishToday()">FINISCI PER OGGI</button>
    </div>
  </section>

</div>

<!-- COMPLETATA -->
<div id="overlay-complete">
  <div style="font-size:110px;">üåü</div>
  <h2 style="font-family:'Fredoka One',cursive;font-size:44px;color:var(--yellow);margin:10px 0 0;">MISSIONE<br>COMPLETATA!</h2>
</div>

<!-- DIARIO -->
<div id="overlay-diario">
  <div class="diary-header">
    <div>
      <h2 class="diary-title">DIARIO <span style="opacity:.9">üìö</span></h2>
      <div class="diary-sub">I tuoi ricordi</div>
    </div>
    <button class="btn-header" style="background: rgba(255,94,108,.90);" onclick="spark.closeDiary()">‚úï</button>
  </div>
  <div class="diary-list" id="diary-list"></div>
</div>

<!-- PARENT GATE -->
<div id="parent-gate">
  <div class="gate-box">
    <h3>AREA GENITORI</h3>
    <p>Quanto fa 5 + 5?</p>
    <input type="number" id="gate-input" pattern="[0-9]*" inputmode="numeric" placeholder="?">
    <div class="gate-actions">
      <button class="btn-ctrl" style="background:#4a5568;" onclick="spark.closeParent()">CHIUDI</button>
      <button class="btn-ctrl" style="background:var(--cyan);" onclick="spark.verifyParent()">SBLOCCA</button>
    </div>
  </div>
</div>

<script>
  const DB = {
    "5-7": [
      { id:"s1", t:"Antenna Spaziale", s:"La base ha perso il segnale satellitare.", o:"Crea un'antenna magica.", p:["Trova un cucchiaio o un oggetto lungo.","Portalo vicino a una finestra e tienilo in alto.","D√¨ 'Bip Bip Bip' per 3 volte."] },
      { id:"s2", t:"Polvere di Stelle", s:"Un'onda di polvere ha coperto i motori.", o:"Pulisci i pannelli solari.", p:["Prendi un calzino o un panno morbido.","Pulisci tre superfici diverse nella stanza.","Soffia forte su ogni punto pulito!"] },
      { id:"s3", t:"Gravit√† Zero", s:"Il computer ha tolto la gravit√†!", o:"Muoviti come se fluttuassi.", p:["Fai 5 passi lentissimi alzando molto le ginocchia.","Tocca un mobile alto con la punta delle dita.","Fai un salto e atterra senza fare rumore."] },
      { id:"s4", t:"Ghiaccio Stellare", s:"Serve energia fredda per il reattore.", o:"Recupera i cristalli spaziali.", p:["Trova 5 piccoli oggetti bianchi in casa.","Portali uno alla volta nella tua base.","Mettili in ordine dal pi√π piccolo al pi√π grande."] },
      { id:"s5", t:"Mappa Galattica", s:"Le stelle sono disordinate oggi.", o:"Riordina la mappa dei pianeti.", p:["Trova tre cuscini o tre libri.","Mettili a terra creando un triangolo.","Salta dentro al triangolo e d√¨ 'Orbita!'"] },
      { id:"s6", t:"Luci di Emergenza", s:"L'astronave √® troppo buia.", o:"Riaccendi le luci di bordo.", p:["Tocca 4 angoli diversi della stanza.","D√¨ 'Clic' ogni volta che ne tocchi uno.","Torna al centro e batti le mani."] }
    ],
    "8-10": [
      { id:"b1", t:"Riparazione Modulo", s:"Un bullone si √® allentato fuori dallo scafo.", o:"Esegui una riparazione tecnica.", p:["Trova un oggetto con tappo a vite (es. bottiglia).","Svita e riavvita il tappo per 5 volte.","Stringi fortissimo alla fine e d√¨ 'Fatto!'"] },
      { id:"b2", t:"Codice Binario", s:"Dobbiamo inviare un segnale criptato.", o:"Componi il ritmo del codice.", p:["Batti le mani 3 volte forte e 2 piano.","Ripeti la sequenza saltando sul posto.","Fai un inchino spaziale verso la Terra."] },
      { id:"b3", t:"Scanner Alieno", s:"Il radar ha intercettato un oggetto ignoto.", o:"Analizza l'area intorno a te.", p:["Chiudi gli occhi e ascolta per 10 secondi.","Trova un oggetto che non hai mai toccato oggi.","Descrivi a voce alta di che materiale √® fatto."] },
      { id:"b4", t:"Navigazione Silenziosa", s:"Dobbiamo passare vicino a un buco nero.", o:"Attraversa il settore senza rumore.", p:["Cammina per la stanza senza far sentire i passi.","Sposta una sedia senza strisciarla a terra.","Siediti lentamente senza fare alcun suono."] },
      { id:"b5", t:"Equilibrio Orbitale", s:"L'astronave sta oscillando troppo.", o:"Stabilizza il centro di massa.", p:["Metti un libro o un cuscino sulla testa.","Fai 5 passi senza farlo cadere.","Girati su te stesso e siediti piano."] },
      { id:"b6", t:"Lancio d'Emergenza", s:"La capsula deve essere pronta al distacco.", o:"Controlla i sistemi di lancio.", p:["Fai 10 saltelli sul posto velocissimi.","Fai 3 respiri profondi per calmare il cuore.","Conta da 10 a 0 a voce alta e d√¨ 'Lancio!'"] }
    ],
    "spec": { id:"spec", t:"Sincronia Stellare ü§ù", s:"I motori richiedono due piloti sincronizzati.", o:"Muovetevi insieme.", p:["Prendetevi per mano (Genitore e Bambino).","Fate 10 passi sincronizzati senza lasciarvi.","Sussurrate 'Pronti al lancio' nello stesso istante!"] }
  };

  const spark = {
    state: {
      dayKey: "",                // ISO yyyy-mm-dd
      missionsDoneToday: 0,      // max 3
      specialDoneToday: false,
      usedMissionIds: [],
      diary: [],
      audioOn: true,
      eta: null,
      currentMissionId: null,
      passo: 0,
      fsm: "home"
    },

    _todayISO(){
      return new Date().toISOString().slice(0,10);
    },

    init(){
      const saved = localStorage.getItem("sparkplay_spazio_state_v1");
      const today = this._todayISO();

      if(saved){
        try{
          const parsed = JSON.parse(saved);
          // porta dietro diario/audio sempre
          this.state.diary = parsed.diary || [];
          this.state.audioOn = (parsed.audioOn !== undefined) ? parsed.audioOn : true;

          // se stesso giorno, riprendi tutto
          if(parsed.dayKey === today){
            this.state = Object.assign(this.state, parsed);
          }else{
            // nuovo giorno: reset progress, mantieni diario/audio
            this.state.dayKey = today;
            this.state.missionsDoneToday = 0;
            this.state.specialDoneToday = false;
            this.state.usedMissionIds = [];
            this.state.currentMissionId = null;
            this.state.passo = 0;
            this.state.fsm = "home";
            this.state.eta = null;
          }
        }catch(e){
          // ignore e riparti pulito
          this.state.dayKey = today;
        }
      }else{
        this.state.dayKey = today;
      }

      this.updateUI();
    },

    save(){
      localStorage.setItem("sparkplay_spazio_state_v1", JSON.stringify(this.state));
    },

    showScreen(id){
      this.state.fsm = id;
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const target = document.getElementById("screen-" + id);
      if(target) target.classList.add("active");
      this.updateChips();
      this.save();
    },

    updateChips(){
      const done = Math.min(3, this.state.missionsDoneToday);
      document.getElementById("chip-today").innerText = `OGGI: ${done}/3`;
      document.getElementById("chip-eta").innerText = `ET√Ä: ${this.state.eta || "--"}`;
      document.getElementById("audioBtn").innerText = this.state.audioOn ? "üîä" : "üîà";
    },

    updateUI(){
      // clamp safety
      this.state.missionsDoneToday = Math.min(3, this.state.missionsDoneToday || 0);

      // special button visibility
      const btnSpecial = document.getElementById("btn-special");
      if(btnSpecial){
        btnSpecial.style.display = this.state.specialDoneToday ? "none" : "block";
      }

      this.updateChips();
      this.showScreen(this.state.fsm);
      if(this.state.fsm === "gioco" && this.state.currentMissionId){
        this.renderMission();
      }
    },

    toggleAudio(){
      this.state.audioOn = !this.state.audioOn;
      if(!this.state.audioOn) window.speechSynthesis.cancel();
      this.updateChips();
      this.save();
    },

    speak(text){
      if(!this.state.audioOn) return;
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "it-IT";
      msg.rate = 0.9;
      window.speechSynthesis.speak(msg);
    },

    goToEta(){
      this.showScreen("eta");
    },

    selectEta(val){
      this.state.eta = val;
      this.loadMission();
    },

    pickMissionId(){
      const pool = DB[this.state.eta] || [];
      const available = pool.filter(m => !this.state.usedMissionIds.includes(m.id));
      const chosen = available.length ? available[0] : pool[0];
      return chosen ? chosen.id : null;
    },

    getMission(){
      if(this.state.currentMissionId === "spec") return DB["spec"];
      const pool = DB[this.state.eta] || [];
      return pool.find(x => x.id === this.state.currentMissionId) || pool[0];
    },

    loadMission(){
      if(!this.state.eta){ this.showScreen("eta"); return; }
      const id = this.pickMissionId();
      if(!id){ this.showScreen("eta"); return; }

      this.state.currentMissionId = id;
      this.state.passo = 0;

      this.renderMission();
      this.showScreen("gioco");

      const m = this.getMission();
      this.speak(m.s + ". OBIETTIVO: " + m.o + ". Passaggio 1: " + m.p[0]);
      this.save();
    },

    renderMission(){
      const m = this.getMission();
      if(!m) return;

      document.getElementById("pill-eta").innerText = `ET√Ä: ${this.state.eta || "--"}`;
      document.getElementById("mission-title").innerText = m.t;
      document.getElementById("mission-story").innerText = m.s;
      document.getElementById("mission-goal").innerHTML = `<b>OBIETTIVO</b>${m.o}`;

      const steps = document.getElementById("mission-steps");
      steps.innerHTML = "";
      m.p.forEach((txt, i) => {
        const div = document.createElement("div");
        div.className = "step" + (i === this.state.passo ? " active" : "");
        div.innerHTML = `<div class="step-num">${i+1}</div><div>${txt}</div>`;
        steps.appendChild(div);
      });

      document.getElementById("btn-back").style.visibility = this.state.passo === 0 ? "hidden" : "visible";
      document.getElementById("btn-next").innerText = (this.state.passo === m.p.length - 1) ? "COMPLETA ‚úÖ" : "AVANTI";
    },

    nextStep(){
      const m = this.getMission();
      if(!m) return;

      if(this.state.passo < m.p.length - 1){
        this.state.passo++;
        this.renderMission();
        this.speak("Passaggio " + (this.state.passo+1) + ": " + m.p[this.state.passo]);
        this.save();
      }else{
        this.completeMission(m);
      }
    },

    prevStep(){
      if(this.state.passo > 0){
        this.state.passo--;
        this.renderMission();
        this.save();
      }
    },

    completeMission(m){
      const overlay = document.getElementById("overlay-complete");
      overlay.style.display = "flex";
      this.speak("Missione completata! Bravissimo!");

      setTimeout(() => {
        overlay.style.display = "none";

        if(m.id !== "spec"){
          // incrementa max 3
          this.state.missionsDoneToday = Math.min(3, (this.state.missionsDoneToday || 0) + 1);
          this.state.usedMissionIds.push(m.id);

          // diario
          this.state.diary.unshift({
            t: m.t,
            d: new Date().toLocaleDateString("it-IT"),
            e: this.state.eta,
            id: m.id
          });
          if(this.state.diary.length > 80) this.state.diary.pop();

          this.state.currentMissionId = null;
          this.state.passo = 0;

          if(this.state.missionsDoneToday >= 3){
            this.showScreen("genitore");
          }else{
            this.loadMission();
          }
        }else{
          this.state.specialDoneToday = true;
          this.state.currentMissionId = null;
          this.state.passo = 0;
          this.showScreen("genitore");
        }

        this.updateUI();
        this.save();
      }, 1400);
    },

    // Diario
    _emojiFor(entry){
      if(entry.id === "spec") return "ü§ù";
      if((entry.id || "").startsWith("s")) return "üöÄ";
      if((entry.id || "").startsWith("b")) return "üß†";
      return "‚ú®";
    },

    openDiary(){
      const list = document.getElementById("diary-list");
      if(!this.state.diary.length){
        list.innerHTML = `<div style="opacity:.7;text-align:center;margin-top:60px;font-weight:900;">
          Nessun ricordo nel diario.<br><span style="opacity:.8">Completa una missione e torna qui ‚ú®</span>
        </div>`;
      }else{
        list.innerHTML = this.state.diary.map(d => `
          <div class="diary-entry">
            <div class="diary-left">
              <div class="diary-emoji">${this._emojiFor(d)}</div>
              <div class="diary-text">
                <b>${d.t}</b>
                <small>${d.d}</small>
              </div>
            </div>
            <div class="diary-meta">${d.e || ""}</div>
          </div>
        `).join("");
      }
      document.getElementById("overlay-diario").style.display = "flex";
      this.save();
    },

    closeDiary(){
      document.getElementById("overlay-diario").style.display = "none";
    },

    // Parent gate
    askParent(action){
      window.parentTask = action;
      document.getElementById("gate-input").value = "";
      document.getElementById("parent-gate").style.display = "flex";
    },
    closeParent(){
      document.getElementById("parent-gate").style.display = "none";
    },
    verifyParent(){
      const val = document.getElementById("gate-input").value;
      if(val === "10"){
        this.closeParent();

        if(window.parentTask === "spec"){
          this.state.currentMissionId = "spec";
          this.state.passo = 0;
          this.renderMission();
          this.showScreen("gioco");
          const ms = DB["spec"];
          this.speak(ms.s + ". OBIETTIVO: " + ms.o + ". Passaggio 1: " + ms.p[0]);
        }else{
          // altre 3 missioni: reset contatore + (opzionale) reset usate oggi per rigiocabilit√†
          this.state.missionsDoneToday = 0;
          this.state.usedMissionIds = [];
          this.state.specialDoneToday = false;
          this.state.currentMissionId = null;
          this.state.passo = 0;
          this.showScreen("eta");
        }

        this.save();
        this.updateUI();
      }else{
        alert("Risposta errata!");
        this.closeParent();
      }
    },

    finishToday(){
      // Niente reload: torna pulito in Home e stop
      window.speechSynthesis.cancel();

      this.state.fsm = "home";
      this.state.eta = null;
      this.state.currentMissionId = null;
      this.state.passo = 0;

      // NON tocchiamo diario.
      this.save();
      this.updateUI();
      this.showScreen("home");
    }
  };

  window.onload = () => spark.init();
</script>

</body>
</html>