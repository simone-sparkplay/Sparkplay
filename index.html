<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#0b1220"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SparkPlay</title>
<style>
:root{
  --bg0:#070B14;
  --bg1:#0B1220;
  --bg2:#0E1530;
  --card:#121B38;
  --card2:#0F1733;
  --stroke:rgba(255,255,255,.12);
  --stroke2:rgba(255,255,255,.18);
  --txt:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.65);
  --muted2:rgba(255,255,255,.52);
  --accent:#1F6BFF;
  --good:#2DCE89;
  --warn:#FFB300;
  --bad:#FF4D4D;
  --shadow:0 30px 70px rgba(0,0,0,.45);
  --r16:16px;
  --r22:22px;
  --r26:26px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--txt);
  background: radial-gradient(1200px 800px at 30% 10%, rgba(60,80,255,.22), transparent 60%),
              radial-gradient(900px 700px at 80% 30%, rgba(150,80,255,.18), transparent 60%),
              linear-gradient(180deg, var(--bg1), var(--bg0));
  font-family: -apple-system, system-ui, Inter, Segoe UI, Roboto, Arial;
  overflow-x:hidden;
}

a{color:inherit}

.sp-root{
  max-width: 520px;
  margin: 0 auto;
  padding: 18px 16px 120px;
}

.header{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:12px;
  margin-top: 4px;
}
.brand{
  display:flex; flex-direction:column; gap:4px;
}
.brand h1{
  margin:0;
  font-size: 20px;
  letter-spacing:.5px;
}
.brand p{
  margin:0;
  color:var(--muted);
  font-size: 13px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.18);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color:rgba(255,255,255,.82);
  font-size: 13px;
  white-space:nowrap;
}

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--stroke);
  border-radius: var(--r26);
  box-shadow: var(--shadow);
  padding:16px;
}

.section{
  margin-top: 14px;
}

.h2{
  display:flex; align-items:center; gap:10px;
  margin:0 0 6px 0;
  font-size: 26px;
}
.sub{
  margin:0;
  color:var(--muted);
  font-size: 14px;
  line-height: 1.35;
}

.btn{
  width:100%;
  border:0;
  border-radius: 16px;
  padding: 14px 14px;
  font-size: 16px;
  font-weight: 800;
  cursor:pointer;
  color:white;
  background: linear-gradient(180deg, rgba(31,107,255,1), rgba(31,107,255,.72));
  box-shadow: 0 12px 30px rgba(31,107,255,.22);
}
.btn:active{transform: translateY(1px)}

.btn-ghost{
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16);
  box-shadow:none;
}

.row{
  display:flex; gap:10px; flex-wrap:wrap;
}
.row .btn{flex:1; min-width: 160px}

.hr{
  height:1px; width:100%;
  background: rgba(255,255,255,.10);
  margin: 14px 0;
}

.step{
  background:#0e1530;
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:14px;
  margin-bottom:10px;
  font-size:14px;
  color:rgba(255,255,255,.90);
}

.diary-item{
  background:#0e1530;
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  margin-bottom:8px;
  font-size:13px;
  color:rgba(255,255,255,.88);
}

.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  color: rgba(255,255,255,.86);
  font-size: 12px;
}

.center{text-align:center}

/* --- extra safety / version badge --- */
.sp-version {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
  background: rgba(0,0,0,.35);
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  color: rgba(255,255,255,.85);
  font: 12px/1.2 -apple-system, system-ui, Inter, Segoe UI, Roboto, Arial;
  padding: 8px 10px;
  border-radius: 999px;
}

.sp-debug {
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: 12px;
  z-index: 99999;
  background: rgba(0,0,0,.72);
  color: #fff;
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 14px;
  padding: 12px;
  font: 12px/1.35 -apple-system, system-ui, Inter, Segoe UI, Roboto, Arial;
  white-space: pre-wrap;
  max-height: 45vh;
  overflow: auto;
  display: none;
}

.sp-debug.show { display:block; }
.sp-recover-actions { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.sp-recover-actions button {
  appearance: none;
  border: 0;
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 700;
}
</style>
</head>
<body>
<div class="sp-version" id="SP_VERSION">v2026.02.17-03</div>
<div id="SPARKPLAY_APP" class="sp-root"></div>
<div class="sp-debug" id="SP_DEBUG"></div>

<script>
/* SparkPlay wrapper: error surface + watchdog (no more "schermata blu muta") */
(function(){
  const DEBUG_BOX = document.getElementById('SP_DEBUG');
  function showDebug(title, msg){
    try{
      DEBUG_BOX.classList.add('show');
      DEBUG_BOX.textContent = title + "\n\n" + msg;
    }catch(e){}
  }
  window.addEventListener('error', function(e){
    const src = (e.filename || '') + ':' + (e.lineno || '') + ':' + (e.colno || '');
    showDebug('‚ö†Ô∏è Errore JavaScript', String(e.message || e.error || 'Errore') + "\n" + src);
  });
  window.addEventListener('unhandledrejection', function(e){
    const r = e.reason;
    const txt = (r && (r.stack || r.message)) ? (r.stack || r.message) : String(r);
    showDebug('‚ö†Ô∏è Errore (Promise)', txt);
  });

  // watchdog: if app doesn't render, show recovery UI
  setTimeout(function(){
    const root = document.getElementById('SPARKPLAY_APP');
    if (!root) return;
    if (root.childElementCount === 0){
      const msg = [
        "SparkPlay non si √® avviato correttamente.",
        "",
        "Pu√≤ succedere dopo un aggiornamento o se la cache del browser √® in conflitto.",
        "",
        "Prova prima: Ricarica.",
        "Se non basta: Reset dati (solo test)."
      ].join("\n");
      showDebug("üõ†Ô∏è Modalit√† recupero", msg);

      const actions = document.createElement('div');
      actions.className = 'sp-recover-actions';
      actions.innerHTML =
        '<button onclick="location.reload()" style="background:#2DCE89;color:#08110b;">Ricarica</button>' +
        '<button onclick="(function(){localStorage.clear();sessionStorage.clear();location.reload();})()" style="background:#ffb300;color:#2a1a00;">Reset dati</button>' +
        '<button onclick="document.getElementById(\'SP_DEBUG\').classList.remove(\'show\')" style="background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.2);">Chiudi</button>';
      DEBUG_BOX.appendChild(actions);
    }
  }, 1400);
})();
</script>

<script>
/* ======== game.js (embedded) ======== */
(()=>{"use strict";
/* SparkPlay CORE v1.2 -- Spazio Master (Premium Light)
   - Netlify-ready: index.html + style.css + game.js
   - One root listener (event delegation)
   - Fix: text color always light (no black-on-blue)
   - Audio unlock: must be started by user gesture (Chrome/iOS)
*/

const ROOT="SPARKPLAY_APP";
const KEY="sp_v12_spazio";
const today=()=>new Date().toDateString();
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

const MISSIONS=[
  {phase:"Calma", icon:"üåô", title:"Respiro dell‚ÄôAstronauta", short:"3 respiri lenti guardando un punto sul soffitto.", long:"Fai 5 respiri: inspira 4, trattieni 2, espira 6. Poi racconta al genitore cosa hai "sentito" nel corpo.", steps:[
    "Siediti comodo come in navicella.",
    "Inspira 4 secondi.",
    "Trattieni 2 secondi.",
    "Espira 6 secondi.",
    "Ripeti 5 volte."
  ]},
  {phase:"Crea", icon:"üß±", title:"Costruisci la Base", short:"Costruisci una mini-base con 5 oggetti.", long:"Crea una base spaziale con 7 oggetti di casa. Deve avere: ingresso, torre, zona "energia". Spiega al genitore cosa fa ogni parte.", steps:[
    "Scegli 7 oggetti (libro, scatola, cucchiaio‚Ä¶).",
    "Costruisci un ingresso.",
    "Aggiungi una torre di controllo.",
    "Crea una zona energia.",
    "Fai un tour guidato."
  ]},
  {phase:"Esplora", icon:"üõ∞Ô∏è", title:"Radar Spaziale", short:"Trova 3 "segnali" in casa (suoni/oggetti).", long:"Accendi il radar: trova 5 "segnali" in casa. Ogni segnale va descritto con 2 dettagli. Poi fai una mini-mappa mentale e raccontala al genitore.", steps:[
    "Cammina piano come astronauta.",
    "Trova un segnale (oggetto o suono).",
    "Descrivi 2 dettagli.",
    "Ripeti fino a 5 segnali.",
    "Racconta la missione al genitore."
  ]}
];

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) return {day:today(), step:0, diary:[]};
    const s=JSON.parse(raw);
    if(!s || typeof s!=="object") return {day:today(), step:0, diary:[]};
    if(s.day!==today()) return {day:today(), step:0, diary:(s.diary||[])};
    return {day:s.day||today(), step:clamp(+s.step||0,0,3), diary:Array.isArray(s.diary)?s.diary:[]};
  }catch(e){
    return {day:today(), step:0, diary:[]};
  }
}
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }

let state=load();

function viewHome(){
  const done = state.step>=3;
  const m = MISSIONS[state.step] || MISSIONS[0];

  if(done){
    return `
      <div class="header">
        <div class="brand">
          <h1>SPARKPLAY</h1>
          <p>Montessori ‚Ä¢ gioco nel mondo reale</p>
        </div>
        <div class="pill">Spazio</div>
      </div>

      <div class="section card">
        <h2 class="h2">üåô Fine per oggi</h2>
        <p class="sub"><b>SparkPlay si ferma qui:</b> 3 missioni fatte bene valgono pi√π di 30 random.</p>
        <div class="hr"></div>
        <p class="sub"><b>Rituale genitore (30 sec):</b><br/>Chiedi: "Qual √® stata la tua parte preferita?"</p>
        <div class="hr"></div>
        <div class="row">
          <button class="btn btn-ghost" data-act="restart">Ricomincia (test)</button>
        </div>
      </div>

      <div class="section card">
        <h2 class="h2">üìì Diario missioni</h2>
        <p class="sub">Piccolo storico delle missioni completate.</p>
        <div class="hr"></div>
        ${renderDiary()}
      </div>
    `;
  }

  return `
    <div class="header">
      <div class="brand">
        <h1>SPARKPLAY</h1>
        <p>Montessori ‚Ä¢ gioco nel mondo reale</p>
      </div>
      <div class="pill">Spazio</div>
    </div>

    <div class="section card">
      <div class="badge">${m.icon} <b>${m.phase}</b> ‚Ä¢ missione ${state.step+1}/3</div>
      <div style="height:10px"></div>
      <h2 class="h2">${m.title}</h2>
      <p class="sub">Scegli una durata. Poi fai la missione nel mondo reale.</p>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" data-act="start" data-mode="short">Missione breve</button>
        <button class="btn btn-ghost" data-act="start" data-mode="long">Missione lunga</button>
      </div>
    </div>

    <div class="section card">
      <h2 class="h2">üß† Nota Montessori</h2>
      <p class="sub">Poche missioni, fatte bene. Il valore √® nella storia che il bambino racconta dopo.</p>
    </div>
  `;
}

function viewMission(mode){
  const m = MISSIONS[state.step] || MISSIONS[0];
  const text = (mode==="long") ? m.long : m.short;
  const steps = (mode==="long") ? m.steps : m.steps.slice(0,3);

  return `
    <div class="header">
      <div class="brand">
        <h1>SPARKPLAY</h1>
        <p>Spazio ‚Ä¢ missione ${state.step+1}/3</p>
      </div>
      <div class="pill">${m.icon} ${m.phase}</div>
    </div>

    <div class="section card">
      <h2 class="h2">${m.title}</h2>
      <p class="sub">${text}</p>
      <div class="hr"></div>
      ${steps.map(s=>`<div class="step">${s}</div>`).join("")}
      <div style="height:8px"></div>
      <button class="btn" data-act="complete">Missione completata</button>
      <div style="height:10px"></div>
      <button class="btn btn-ghost" data-act="back">Indietro</button>
    </div>
  `;
}

function renderDiary(){
  if(!state.diary.length){
    return `<p class="sub">Nessuna missione salvata ancora.</p>`;
  }
  return state.diary.slice(0,12).map(d=>`
    <div class="diary-item">
      <div style="font-weight:800;">${d.icon||"‚≠ê"} ${d.phase} -- ${d.title}</div>
      <div style="color:rgba(255,255,255,.62);margin-top:4px;">${d.ts||""}</div>
    </div>
  `).join("");
}

let screen="home";
let mode="short";

function render(){
  const root=document.getElementById(ROOT);
  if(!root) return;
  root.innerHTML = (screen==="home") ? viewHome() : viewMission(mode);
}

function complete(){
  const m = MISSIONS[state.step];
  state.diary.unshift({
    phase:m.phase,
    icon:m.icon,
    title:m.title,
    ts: new Date().toLocaleString("it-IT")
  });
  state.step++;
  save();
  screen="home";
  render();
}

function restartForTest(){
  state.day=today();
  state.step=0;
  save();
  screen="home";
  render();
}

document.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.getAttribute("data-act");
  if(act==="start"){
    mode = btn.getAttribute("data-mode") || "short";
    screen="mission";
    render();
  }
  if(act==="back"){
    screen="home";
    render();
  }
  if(act==="complete"){
    complete();
  }
  if(act==="restart"){
    restartForTest();
  }
});

render();
})();
</script>
</body>
</html>