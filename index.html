<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#0B1220"/>
<title>SparkPlay</title>
<style>
/* SparkPlay CORE v1.2 -- Spazio Master (Premium Light) */
:root{
  --bg0:#070B14; --bg1:#0B1220; --ink:#EAF2FF; --muted:#A9B7D6; --line:rgba(255,255,255,.10);
  --accent:#3F5EF6; --gold:#FFB300; --rad:26px; --shadow:0 30px 70px rgba(0,0,0,.45);
  --ok:#2DCE89; --warn:#FF7A00;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: -apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Arial,sans-serif;
  color:var(--ink);
  background: radial-gradient(1200px 700px at 30% 10%, rgba(63,94,246,.35), transparent 60%),
              radial-gradient(900px 500px at 80% 20%, rgba(255,179,0,.18), transparent 55%),
              linear-gradient(180deg,var(--bg1),var(--bg0));
  -webkit-font-smoothing:antialiased;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
a{color:inherit}
button{font-family:inherit}
.sp-root{min-height:100%; padding:20px 16px 26px}
.container{max-width:520px;margin:0 auto}
.header{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:16px;
}
.brand{
  display:flex; flex-direction:column; gap:4px;
}
.brand h1{font-size:18px; margin:0; letter-spacing:.5px}
.brand small{color:var(--muted)}
.pill{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.22);
  padding:8px 12px; border-radius:999px;
  color:rgba(255,255,255,.88);
  font-weight:800;
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
}
.card{
  background:rgba(8,12,24,.62);
  border:1px solid rgba(255,255,255,.10);
  border-radius:var(--rad);
  padding:18px 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  margin-bottom:14px;
}
.card h2{margin:0 0 10px 0; font-size:18px}
.card p{margin:0; color:rgba(234,242,255,.88); line-height:1.45}
.row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
.btn{
  border:0; border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  color:#06100b;
  background:var(--ok);
  box-shadow:0 16px 40px rgba(45,206,137,.18);
}
.btn.secondary{
  background:rgba(255,255,255,.12);
  color:rgba(255,255,255,.92);
  border:1px solid rgba(255,255,255,.16);
  box-shadow:none;
}
.btn.warn{
  background:var(--gold);
  color:#2a1a00;
  box-shadow:0 16px 40px rgba(255,179,0,.12);
}
.meta{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(255,255,255,.92);
  font-weight:800;
}
.progress{
  height:12px; width:100%;
  background:rgba(255,255,255,.10);
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  margin-top:12px;
}
.progress > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(63,94,246,1), rgba(255,179,0,1));
  border-radius:999px;
  transition: width .35s ease;
}
.step{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:14px;
  margin-bottom:10px;
  font-size:14px;
  line-height:1.45;
  color:rgba(234,242,255,.92);
}
.diary-item{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  margin-bottom:8px;
  font-size:13px;
  color:rgba(234,242,255,.92);
}
.small{font-size:12px;color:rgba(234,242,255,.70)}
.center{text-align:center}
</style>
</head>
<body>

<div id="SPARKPLAY_APP" class="sp-root"></div>

<!-- version pill -->
<div style="position:fixed;top:10px;right:10px;z-index:9999;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:rgba(255,255,255,.85);font:12px/1.2 -apple-system,system-ui,Inter,Segoe UI,Roboto,Arial;padding:8px 10px;border-radius:999px;">v2026.02.17-04</div>

<!-- debug / recovery -->
<div id="SP_DEBUG" style="position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;background:rgba(0,0,0,.80);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:12px;font:12px/1.35 -apple-system,system-ui,Inter,Segoe UI,Roboto,Arial;white-space:pre-wrap;max-height:45vh;overflow:auto;display:none;"></div>

<script>
(function(){
  const box=document.getElementById('SP_DEBUG');
  function show(title,msg,withActions){
    if(!box) return;
    box.style.display='block';
    box.textContent=title+"\n\n"+msg;
    if(withActions){
      const wrap=document.createElement('div');
      wrap.style.display='flex';
      wrap.style.gap='10px';
      wrap.style.marginTop='10px';
      wrap.style.flexWrap='wrap';
      wrap.innerHTML =
        '<button style="border:0;border-radius:12px;padding:10px 12px;font-weight:800;background:#2DCE89;color:#06100b" onclick="location.reload()">Ricarica</button>'+
        '<button style="border:0;border-radius:12px;padding:10px 12px;font-weight:800;background:#FFB300;color:#2a1a00" onclick="(function(){try{localStorage.clear();}catch(e){} try{sessionStorage.clear();}catch(e){} location.reload();})()">Reset dati</button>'+
        '<button style="border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:10px 12px;font-weight:800;background:rgba(255,255,255,.10);color:#fff" onclick="document.getElementById(\'SP_DEBUG\').style.display=\'none\'">Chiudi</button>';
      box.appendChild(wrap);
    }
  }
  window.addEventListener('error', function(e){
    const src=(e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||'');
    show('‚ö†Ô∏è Errore JavaScript', String(e.message||e.error||'Errore')+"\n"+src, false);
  });
  window.addEventListener('unhandledrejection', function(e){
    const r=e.reason;
    const txt=(r&&(r.stack||r.message))?(r.stack||r.message):String(r);
    show('‚ö†Ô∏è Errore (Promise)', txt, false);
  });
  setTimeout(function(){
    const root=document.getElementById('SPARKPLAY_APP');
    if(!root) return;
    if(root.childElementCount===0){
      show('üõ†Ô∏è Modalit√† recupero',
        'SparkPlay non si √® avviato correttamente.\n\n'+
        'Pu√≤ succedere dopo un aggiornamento o se la cache del browser √® in conflitto.\n\n'+
        'Prova prima: Ricarica.\nSe non basta: Reset dati (solo test).', true);
    }
  }, 1200);
})();
</script>

<script>
(()=>{"use strict";
/* SparkPlay CORE v1.2 -- Spazio Master (Premium Light)
   - Netlify-ready: index.html + style.css + game.js
   - One root listener (event delegation)
   - Fix: text color always light (no black-on-blue)
   - Audio unlock: must be started by user gesture (Chrome/iOS)
*/

const ROOT="SPARKPLAY_APP";
const KEY="sp_v12_spazio";
const today=()=>new Date().toDateString();
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

const MISSIONS=[
  {phase:"Calma", icon:"üåô", title:"Respiro dell‚ÄôAstronauta", short:"Fai 6 respiri lenti: 4 secondi inspiro, 4 secondi espiro.", long:"Sedetevi. Mano sulla pancia. Fate 6 respiri lenti: 4 sec inspiro, 4 sec espiro. Alla fine: ‚ÄòCome si sente il corpo?‚Äô", steps:[
    "Sedetevi comodi.",
    "Mano sulla pancia.",
    "Inspira 4 secondi.",
    "Espira 4 secondi.",
    "Ripeti 6 volte.",
    "Chiedi: "Come si sente il corpo?""
  ]},
  {phase:"Crea", icon:"üß±", title:"Costruisci la Base", short:"Con cuscini e sedie crea una base spaziale.", long:"Costruite una base spaziale con cuscini/sedie. Poi scegliete: ingresso, sala comandi, area riposo. Alla fine: ‚ÄòQual √® la regola della base?‚Äô", steps:[
    "Scegli 3 oggetti (cuscini, sedie, lenzuolo).",
    "Costruisci l‚Äôingresso.",
    "Crea la sala comandi.",
    "Crea l‚Äôarea riposo.",
    "Decidi una regola della base.",
    "Mostra la base al genitore."
  ]},
  {phase:"Esplora", icon:"üõ∞Ô∏è", title:"Radar Spaziale", short:"Trova 5 oggetti ‚Äòspaziali‚Äô in casa (tondi, metallici, luminosi).", long:"Avvia la ‚Äòscansione‚Äô: trovate 5 oggetti spaziali (tondi/metallici/luminosi). Per ciascuno: nome, funzione, dove si usa nello spazio.", steps:[
    "Dite: "Avvio scansione‚Ä¶"",
    "Trova un oggetto tondo.",
    "Trova un oggetto metallico.",
    "Trova un oggetto luminoso.",
    "Dagli un nome spaziale.",
    "Spiega a cosa serve sulla navicella."
  ]},
  {phase:"Speciale", icon:"ü™ê", title:"Missione Speciale -- Segnale Misterioso", short:"Decifra un segnale: batti 3 ritmi e falla indovinare.", long:"Crea un ‚Äòsegnale‚Äô con 3 ritmi (batti mani/tavolo). L‚Äôaltro deve copiarlo. Aumenta difficolt√†: 4 ritmi. Finale: inventate cosa dice il segnale.", steps:[
    "Crea un ritmo di 3 battiti.",
    "L‚Äôaltro lo ripete.",
    "Aggiungi un 4¬∞ battito.",
    "Inventate un messaggio segreto.",
    "Fate un saluto spaziale finale."
  ]}
];

const STATE_DEFAULT=()=>({
  day: today(),
  step: 0,                 // 0..2 for daily missions
  daily: [],               // array of 3 missions chosen for the day
  completed: false,        // day finished
  diary: []                // recent completions
});

function safeLoad(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) return STATE_DEFAULT();
    const s=JSON.parse(raw);
    if(!s || typeof s!=="object") return STATE_DEFAULT();
    // daily reset
    if(s.day!==today()){
      return STATE_DEFAULT();
    }
    // normalize
    s.step=clamp(Number(s.step||0),0,3);
    s.daily=Array.isArray(s.daily)?s.daily:[];
    s.completed=!!s.completed;
    s.diary=Array.isArray(s.diary)?s.diary:[];
    return s;
  }catch(e){
    return STATE_DEFAULT();
  }
}
function safeSave(state){
  try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
}

let state = safeLoad();

function pickDailyMissions(){
  // choose 3 missions from Calma/Crea/Esplora (no Speciale)
  const base = MISSIONS.filter(m=>m.phase!=="Speciale");
  // deterministic-ish shuffle by date
  const seed = (new Date(state.day).getTime()/86400000)|0;
  const rng = mulberry32(seed);
  const shuffled = base.slice().sort(()=>rng()-0.5);
  state.daily = shuffled.slice(0,3);
  state.step = 0;
  state.completed = false;
  safeSave(state);
}

function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function el(html){
  const t=document.createElement('template');
  t.innerHTML=html.trim();
  return t.content.firstElementChild;
}

function render(){
  const root=document.getElementById(ROOT);
  if(!root) return;

  if(!state.daily || state.daily.length!==3){
    pickDailyMissions();
  }

  const doneCount = clamp(state.step,0,3);
  const percent = Math.round((doneCount/3)*100);

  const currentMission = state.completed ? null : state.daily[state.step];

  const app = el(`
    <div class="container">
      <div class="header">
        <div class="brand">
          <h1>SPARKPLAY</h1>
          <small>Montessori ¬∑ gioco nel mondo reale</small>
        </div>
        <div class="pill">Spazio</div>
      </div>

      ${state.completed ? `
        <div class="card center">
          <h2>üåô Fine per oggi</h2>
          <p><b>SparkPlay si ferma qui:</b> <b>3 missioni fatte bene</b> valgono pi√π di 30 random.</p>
          <p style="margin-top:10px"><b>Rituale genitore (30 sec):</b><br/>Chiedi: "Qual √® stata la tua parte preferita?"</p>
          <div class="row" style="justify-content:center">
            <button class="btn secondary" data-action="newday">Ricomincia (test)</button>
            <button class="btn warn" data-action="special">Missione speciale</button>
          </div>
        </div>

        <div class="card">
          <h2>üìì Diario missioni</h2>
          <p class="small">Piccolo storico delle missioni completate.</p>
          <div style="margin-top:12px">
            ${state.diary.length? state.diary.slice(0,12).map(d=>`
              <div class="diary-item"><b>${d.icon} ${d.phase}</b> -- ${d.title}<div class="small">${new Date(d.ts).toLocaleString()}</div></div>
            `).join("") : `<div class="diary-item">Nessuna missione registrata.</div>`}
          </div>
        </div>
      ` : `
        <div class="card">
          <h2>${currentMission.icon} Missione ${state.step+1}/3 -- ${currentMission.phase}</h2>
          <p><b>${currentMission.title}</b></p>

          <div class="meta">
            <span class="chip">üéØ Oggi: 3 missioni</span>
            <span class="chip">‚úÖ Fatto: ${doneCount}/3</span>
          </div>

          <div class="progress"><div style="width:${percent}%"></div></div>

          <div class="row">
            <button class="btn" data-action="mode" data-mode="short">Missione breve</button>
            <button class="btn secondary" data-action="mode" data-mode="long">Missione lunga</button>
            <button class="btn warn" data-action="audio">üîä Ascolta</button>
          </div>
        </div>

        <div class="card" id="missionContent">
          ${renderMissionContent(currentMission, state.mode||"short")}
          <div class="row">
            <button class="btn" data-action="complete">Missione completata</button>
          </div>
        </div>
      `}
    </div>
  `);

  root.innerHTML="";
  root.appendChild(app);
}

function renderMissionContent(m, mode){
  const desc = (mode==="long") ? m.long : m.short;
  return `
    <p style="margin-bottom:12px">${desc}</p>
    <div class="card" style="margin:0; box-shadow:none; background:rgba(255,255,255,.05);">
      ${m.steps.map(s=>`<div class="step">${escapeHtml(s)}</div>`).join("")}
    </div>
  `;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// simple TTS
let ttsEnabled=true;
function speak(text){
  try{
    if(!ttsEnabled) return;
    if(!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang="it-IT";
    u.rate=1.0;
    u.pitch=1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

function completeMission(){
  const m = state.daily[state.step];
  state.diary.unshift({
    ts: Date.now(),
    phase: m.phase,
    icon: m.icon,
    title: m.title
  });
  state.step++;
  if(state.step>=3){
    state.completed=true;
    state.step=3;
  }
  safeSave(state);
  render();
}

function startSpecial(){
  // show special mission in a simple modal card
  const root=document.getElementById(ROOT);
  if(!root) return;
  const m = MISSIONS.find(x=>x.phase==="Speciale");
  const overlay = el(`
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:flex-end;justify-content:center;padding:16px;z-index:99999;">
      <div class="card" style="width:min(520px,100%);margin:0">
        <h2>${m.icon} ${m.title}</h2>
        <p>${m.long}</p>
        <div style="margin-top:12px">
          ${m.steps.map(s=>`<div class="step">${escapeHtml(s)}</div>`).join("")}
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" data-action="closeSpecial">Chiudi</button>
          <button class="btn" data-action="completeSpecial">Segna come fatta</button>
        </div>
      </div>
    </div>
  `);
  root.appendChild(overlay);
}

function closeSpecial(){
  const root=document.getElementById(ROOT);
  const ov = root && root.querySelector('[data-action="closeSpecial"]')?.closest('div[style*="position:fixed"]');
  if(ov) ov.remove();
}

function completeSpecial(){
  const m = MISSIONS.find(x=>x.phase==="Speciale");
  state.diary.unshift({ts:Date.now(), phase:m.phase, icon:m.icon, title:m.title});
  safeSave(state);
  closeSpecial();
  render();
}

function newDayTest(){
  state = STATE_DEFAULT();
  safeSave(state);
  render();
}

// event delegation
document.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  const act = btn.getAttribute("data-action");
  if(!act) return;

  if(act==="mode"){
    const mode = btn.getAttribute("data-mode") || "short";
    state.mode = mode;
    safeSave(state);
    render();
    return;
  }
  if(act==="complete"){ completeMission(); return; }
  if(act==="audio"){
    const m = state.completed ? null : state.daily[state.step];
    if(!m) return;
    const mode = state.mode || "short";
    const text = `${m.phase}. ${m.title}. ${mode==="long"?m.long:m.short}`;
    speak(text);
    return;
  }
  if(act==="newday"){ newDayTest(); return; }
  if(act==="special"){ startSpecial(); return; }
  if(act==="closeSpecial"){ closeSpecial(); return; }
  if(act==="completeSpecial"){ completeSpecial(); return; }
});

render();
})();
</script>

</body>
</html>