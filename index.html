<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SparkPlay</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
  --rossa:#ff5e6c;
  --blu:#00d2ff;
  --giallo:#ffe66d;
  --sfondo:#101835;
  --latte:#f7fff7;
  --glass: rgba(255,255,255,.10);
  --stroke: rgba(255,255,255,.14);
  --shadow: 0 18px 40px rgba(0,0,0,.35);
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%; background:var(--sfondo);}
body{
  margin:0;
  font-family:'Quicksand',sans-serif;
  color:var(--latte);
  overflow:hidden;
  background-image: radial-gradient(circle at 50% 35%, #1a265a 0%, var(--sfondo) 65%, #0b1024 100%);
}

/* FIX barra bianca iPhone/PWA */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:inherit;
  z-index:-1;
}

.sp-root{
  max-width:600px;
  margin:0 auto;
  min-height:100svh;            /* meglio di 100vh su iOS */
  display:flex;
  flex-direction:column;
  padding: calc(env(safe-area-inset-top) + 14px) 18px calc(env(safe-area-inset-bottom) + 14px);
  overflow:hidden;
}

.sp-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding: 6px 0 12px;
}

.brand{
  font-family:'Fredoka One',cursive;
  font-size:36px;
  color:var(--giallo);
  text-shadow:3px 3px var(--rossa);
  letter-spacing:.5px;
  line-height:1;
  text-align:center;
  flex:1;
}

.icon-btn{
  width:56px;
  height:56px;
  border-radius:18px;
  border:1px solid var(--stroke);
  background: var(--glass);
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  padding:0;
}

.icon-btn svg{ width:28px; height:28px; display:block; }
.icon-btn:active{ transform: translateY(1px); }

.content-area{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:14px;
  justify-content:center;
  align-items:center;
  width:100%;
}

.hero{
  width:min(420px, 92%);
  border-radius:26px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
  box-shadow: var(--shadow);
  padding:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
}

.hero .hero-image{
  width:100%;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.08);
  overflow:hidden;
}

.hero .hero-image img{
  width:100%;
  height:auto;
  display:block;
}

.h-title{
  margin: 0;
  color: var(--giallo);
  font-family:'Fredoka One',cursive;
  font-size: 56px;
  letter-spacing: 1px;
  text-shadow: 4px 4px rgba(0,0,0,.22);
}

.btn{
  border:none;
  cursor:pointer;
  border-radius:26px;
  font-family:'Fredoka One',cursive;
}

.btn-main{
  width:100%;
  background: var(--rossa);
  color:#fff;
  padding: 20px 18px;
  font-size: 22px;
  box-shadow: 0 10px 0 #c43d4a, 0 18px 40px rgba(0,0,0,.25);
}
.btn-main:active{ transform: translateY(4px); box-shadow: 0 6px 0 #c43d4a, 0 12px 26px rgba(0,0,0,.2); }

.pills{
  width:100%;
  display:flex;
  gap:12px;
  justify-content:space-between;
}
.pill{
  flex:1;
  padding: 12px 14px;
  border-radius:18px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.10);
  text-align:center;
  font-weight:700;
  color: rgba(255,255,255,.92);
}

.testo-storia{ font-size:20px; line-height:1.45; text-align:center; font-weight:600; opacity:.95; }
.obiettivo-box{
  border:3px dashed var(--blu);
  border-radius:22px;
  padding:14px 14px;
  text-align:center;
  font-weight:800;
  color:var(--blu);
  background: rgba(255,255,255,.06);
  width:100%;
}

.passo{
  padding:16px;
  border-radius:22px;
  background: rgba(255,255,255,.10);
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
  font-weight:800;
  width:100%;
  border:1px solid rgba(255,255,255,.10);
}
.passo .num{
  width:44px; height:44px;
  border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
}
.passo.attivo{
  background: var(--latte);
  color: #0f1837;
  transform: scale(1.02);
  box-shadow: 0 14px 28px rgba(0,0,0,.30);
}
.passo.attivo .num{
  background: var(--rossa);
  border: none;
  color:#fff;
}

#overlay-success{
  position:fixed; inset:0;
  pointer-events:none;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:3000;
  background: rgba(0,0,0,.80);
}
.messaggio-vittoria{
  font-family:'Fredoka One',cursive;
  font-size:46px;
  color:var(--giallo);
  text-shadow:4px 4px var(--rossa);
  text-align:center;
}

#diario-modal{
  position:fixed; inset:0;
  background: radial-gradient(circle at 50% 20%, #1a265a 0%, var(--sfondo) 70%, #0b1024 100%);
  z-index:2000;
  display:none;
  flex-direction:column;
  padding: calc(env(safe-area-inset-top) + 18px) 18px calc(env(safe-area-inset-bottom) + 18px);
  overflow:auto;
}
.diario-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding-bottom:14px;
}
.diario-title{
  font-family:'Fredoka One',cursive;
  font-size:44px;
  color:var(--latte);
  text-shadow: 3px 3px rgba(0,0,0,.25);
}
.diario-sub{
  margin-top:4px;
  color: rgba(0,210,255,.95);
  font-weight:800;
  letter-spacing:.24em;
  font-size:13px;
}
.diario-list{
  display:flex;
  flex-direction:column;
  gap:12px;
  padding-top:10px;
}
.diario-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:16px 16px;
  border-radius:22px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 14px 28px rgba(0,0,0,.22);
}
.diario-left{
  display:flex; align-items:center; gap:12px;
  min-width:0;
}
.diario-icon{
  width:44px; height:44px;
  border-radius:16px;
  background: rgba(0,0,0,.20);
  border:1px solid rgba(255,255,255,.12);
  display:flex; align-items:center; justify-content:center;
}
.diario-icon svg{ width:22px; height:22px; }
.diario-text{ min-width:0; }
.diario-name{
  font-weight:900;
  font-size:22px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.diario-date{ opacity:.75; font-weight:700; margin-top:2px; }
.diario-age{
  padding:10px 12px;
  border-radius:16px;
  background: rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.12);
  font-weight:900;
  color: var(--blu);
  min-width:64px;
  text-align:center;
}

</style>
</head>
<body>

<div id="overlay-success"><div class="messaggio-vittoria">MISSIONE<br>COMPLETATA!</div></div>

<div id="diario-modal">
  <div class="diario-head">
    <div>
      <div class="diario-title">DIARIO</div>
      <div class="diario-sub">I TUOI RICORDI</div>
    </div>
    <button class="btn btn-main" style="width:auto;padding:14px 18px;border-radius:18px;font-size:16px;box-shadow:none" onclick="chiudiDiario()">CHIUDI</button>
  </div>
  <div id="lista-diario" class="diario-list"></div>
</div>

<div id="SPARKPLAY_APP" class="sp-root"></div>

<script>
(()=>{"use strict";

/* -----------------------------
   ICONS (SVG inline = zero quadratini)
-------------------------------- */
const ICONS = {
  book: `
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M6 3.5h9.2c1.7 0 3 1.3 3 3V20c-1-.8-2.1-1.2-3.4-1.2H6c-1.7 0-3-1.3-3-3V6.5c0-1.7 1.3-3 3-3Z"
      stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
    <path d="M7 7h8" stroke="rgba(0,210,255,.95)" stroke-width="2" stroke-linecap="round"/>
    <path d="M7 11h7" stroke="rgba(255,230,109,.95)" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  speakerOn: `
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M4 10v4h3l4 3V7L7 10H4Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
    <path d="M16 9c1 1 1 5 0 6" stroke="rgba(0,210,255,.95)" stroke-width="2" stroke-linecap="round"/>
    <path d="M19 7c2 2 2 8 0 10" stroke="rgba(255,230,109,.95)" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  speakerOff: `
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M4 10v4h3l4 3V7L7 10H4Z" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
    <path d="M16 9l5 6" stroke="rgba(255,94,108,.95)" stroke-width="2" stroke-linecap="round"/>
    <path d="M21 9l-5 6" stroke="rgba(255,94,108,.95)" stroke-width="2" stroke-linecap="round"/>
  </svg>`,
  rocket: `
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M14 3c3 1 5 4 5 7-2 1-4 1-6 0l-2 2-1 4-3-3 4-1 2-2c-1-2-1-4 0-7Z"
      stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
    <path d="M8.5 13.5l2 2" stroke="rgba(0,210,255,.95)" stroke-width="2" stroke-linecap="round"/>
  </svg>`
};

/* -----------------------------
   DB (tolgo sillabazioni che rovinano la voce)
-------------------------------- */
const DB = {
  "5-7": [
    {t:"SEGNALE PERDUTO", s:"La base ha perso il segnale. La galassia Ã¨ al buio!", o:"RIACCENDI L'ANTENNA!", p:[
      "Trova un calzino morbido.",
      "Portalo sulla base, sopra il tappeto.",
      "Di' tre volte a voce alta: bip, bip, bip!"
    ]},
    {t:"SATELLITE MORBIDO", s:"Un satellite Ã¨ caduto tra le stelle!", o:"RECUPERALO!", p:[
      "Trova un peluche.",
      "Fagli fare un giro intorno al tavolo.",
      "Mettilo a riposare in un posto alto."
    ]}
  ],
  "8-10": [
    {t:"MODULO VIBRANTE", s:"Il modulo quattro vibra forte. Serve silenzio assoluto!", o:"RIPARA IN SILENZIO", p:[
      "Trova un foglio di carta.",
      "Portalo alla base senza fare rumore.",
      "Piegalo in quattro e mettilo sotto un cuscino."
    ]}
  ]
};

/* -----------------------------
   STATE
-------------------------------- */
let s = {
  fsm:"INIZIO",
  eta:null,
  passo:0,
  missioniFatte:0,
  missioneAttuale:null,
  audio:true,
  diario:[]
};

/* -----------------------------
   AUDIO: robusto e "premium"
   - stop immediato ad ogni cambio schermata
   - auto parla quando parte missione
-------------------------------- */
let currentUtterance = null;

function normalizeSpeechText(txt){
  if(!txt) return "";
  let t = String(txt);

  // micro-fix pronuncia (aggiungi qui parole che senti "storte")
  const rep = [
    [/calzino/gi, "cal-zÃ¬-no"],     // aiuta TTS italiano
    [/peluche/gi, "pelÃ¹che"],
    [/bip/gi, "bÃ¬p"],
    [/galassia/gi, "ga-lÃ ssia"],
  ];
  rep.forEach(([a,b])=> t = t.replace(a,b));

  // pulizia spazi
  t = t.replace(/\s+/g," ").trim();
  return t;
}

function stopSpeech(){
  try{ speechSynthesis.cancel(); }catch(e){}
  currentUtterance = null;
}

function pickItalianVoice(){
  const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
  // preferisco voci it-IT reali se esistono
  let v = voices.find(v=> (v.lang||"").toLowerCase().startsWith("it"));
  // fallback: prima disponibile
  return v || null;
}

function speak(text){
  if(!s.audio) return;
  const t = normalizeSpeechText(text);
  if(!t) return;

  stopSpeech();

  const u = new SpeechSynthesisUtterance(t);
  u.lang = "it-IT";

  // **velocitÃ  per 5-7**: piÃ¹ lenta
  u.rate = (s.eta === "5-7") ? 0.78 : 0.90;
  u.pitch = 1.05;

  const v = pickItalianVoice();
  if(v) u.voice = v;

  currentUtterance = u;
  speechSynthesis.speak(u);
}

/* Safari iOS: caricare voices richiede evento/tempo */
if("speechSynthesis" in window){
  window.speechSynthesis.onvoiceschanged = ()=>{};
}

/* -----------------------------
   UI RENDER
-------------------------------- */
function renderDiario(){
  const box = document.getElementById("lista-diario");
  if(!box) return;

  if(!s.diario.length){
    box.innerHTML = `<div style="opacity:.8;font-weight:800;padding:10px 2px;">Ancora vuoto. Completa una missione e la troverai qui ðŸ™‚</div>`;
    return;
  }

  box.innerHTML = s.diario.slice().reverse().map(item => `
    <div class="diario-item">
      <div class="diario-left">
        <div class="diario-icon">${ICONS.rocket}</div>
        <div class="diario-text">
          <div class="diario-name">${item.t}</div>
          <div class="diario-date">${item.date}</div>
        </div>
      </div>
      <div class="diario-age">${item.eta}</div>
    </div>
  `).join("");
}

function todayIT(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function disegna(){
  const root = document.getElementById("SPARKPLAY_APP");
  if(!root) return;

  // IMPORTANT: ogni cambio schermata, stop voce (cosÃ¬ non continua a parlare "sotto")
  stopSpeech();

  if(s.fsm === "INIZIO"){
    root.innerHTML = `
      <div class="sp-top">
        <button class="icon-btn" onclick="apriDiario()" aria-label="Diario">${ICONS.book}</button>
        <div class="brand">SPARKPLAY</div>
        <button class="icon-btn" onclick="toggleAudio()" aria-label="Audio">
          ${s.audio ? ICONS.speakerOn : ICONS.speakerOff}
        </button>
      </div>

      <div class="content-area">
        <div class="hero">
          <div class="hero-image">
            <!-- usa il tuo asset: home-hero.png in root -->
            <img src="home-hero.png" alt="SparkPlay">
          </div>
          <h1 class="h-title">PRONTI?</h1>

          <button class="btn btn-main" onclick="vaiEta()">INIZIA MISSIONE</button>

          <div class="pills">
            <div class="pill">OGGI: ${s.missioniFatte}/3</div>
            <div class="pill">ETÃ€: ${s.eta ? s.eta : "--"}</div>
          </div>
        </div>
      </div>
    `;
  }
  else if(s.fsm === "ETA"){
    root.innerHTML = `
      <div class="sp-top">
        <button class="icon-btn" onclick="tornaHome()" aria-label="Indietro"> 
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 6l-6 6 6 6" stroke="rgba(255,255,255,.92)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="brand" style="font-size:26px">CHI SEI?</div>
        <button class="icon-btn" onclick="toggleAudio()" aria-label="Audio">
          ${s.audio ? ICONS.speakerOn : ICONS.speakerOff}
        </button>
      </div>

      <div class="content-area" style="justify-content:flex-start; padding-top:8px;">
        <div style="width:100%; display:flex; flex-direction:column; gap:12px;">
          <button class="btn" style="background:rgba(255,255,255,0.10); border:2px solid var(--blu); color:white; padding:18px; width:100%; display:flex; align-items:center; justify-content:space-between; border-radius:22px;"
            onclick="scegliEta('5-7')">
            <div style="display:flex; align-items:center; gap:12px;">
              <div style="width:46px;height:46px;border-radius:16px;background:rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.10)">${ICONS.rocket}</div>
              <div style="text-align:left">
                <div style="font-weight:900; font-size:18px">ESPLORATORE</div>
                <div style="opacity:.8; font-weight:800">5â€“7 anni</div>
              </div>
            </div>
            <div style="opacity:.8;font-weight:900">â†’</div>
          </button>

          <button class="btn" style="background:rgba(255,255,255,0.10); border:2px solid var(--rossa); color:white; padding:18px; width:100%; display:flex; align-items:center; justify-content:space-between; border-radius:22px;"
            onclick="scegliEta('8-10')">
            <div style="display:flex; align-items:center; gap:12px;">
              <div style="width:46px;height:46px;border-radius:16px;background:rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.10)">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 18h6" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M10 21h4" stroke="rgba(0,210,255,.95)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M12 2c3.3 0 6 2.7 6 6 0 1.4-.5 2.6-1.3 3.6-.6.7-1.2 1.6-1.2 2.6V15H8.5v-.8c0-1-.6-1.9-1.2-2.6C6.5 10.6 6 9.4 6 8c0-3.3 2.7-6 6-6Z"
                    stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linejoin="round"/>
                </svg>
              </div>
              <div style="text-align:left">
                <div style="font-weight:900; font-size:18px">COMANDANTE</div>
                <div style="opacity:.8; font-weight:800">8â€“10 anni</div>
              </div>
            </div>
            <div style="opacity:.8;font-weight:900">â†’</div>
          </button>
        </div>
      </div>
    `;

    // auto-guida vocale per bambini
    setTimeout(()=> speak("Scegli la tua etÃ  per iniziare la missione."), 120);
  }
  else if(s.fsm === "GIOCO"){
    const m = s.missioneAttuale;
    root.innerHTML = `
      <div class="sp-top">
        <button class="icon-btn" onclick="toggleAudio()" aria-label="Audio">
          ${s.audio ? ICONS.speakerOn : ICONS.speakerOff}
        </button>
        <div class="brand" style="font-size:20px">${m.t}</div>
        <button class="btn" style="background:var(--rossa);color:white;padding:12px 14px;border-radius:18px;font-family:'Fredoka One';box-shadow:none"
          onclick="esciGioco()">ESCI</button>
      </div>

      <div class="content-area">
        <div class="testo-storia">${m.s}</div>
        <div class="obiettivo-box">OBIETTIVO: ${m.o}</div>

        <div style="width:100%">
          ${m.p.map((t,i)=>`
            <div class="passo ${i===s.passo?'attivo':''}">
              <div class="num">${i+1}</div>
              <div style="flex:1">${t}</div>
            </div>
          `).join("")}
        </div>

        <button class="btn btn-main" onclick="successivo()">
          ${s.passo < m.p.length-1 ? 'AVANTI' : 'COMPLETA âœ…'}
        </button>
      </div>
    `;

    // auto-voce quando entra in missione:
    // storia + obiettivo + step corrente (di solito 1)
    setTimeout(()=>{
      speak(`${m.s} Obiettivo: ${m.o}. Primo passaggio: ${m.p[s.passo]}`);
    }, 150);
  }
}

/* -----------------------------
   ACTIONS
-------------------------------- */
window.toggleAudio = () => {
  s.audio = !s.audio;
  stopSpeech();
  disegna();
};

window.vaiEta = () => { s.fsm = "ETA"; disegna(); };

window.tornaHome = () => {
  s.fsm = "INIZIO";
  disegna();
};

window.scegliEta = (e) => {
  s.eta = e;
  s.missioniFatte = 0;
  s.diario = []; // reset diario su nuova sessione
  proproxima();
};

function proproxima(){
  if(s.missioniFatte < (DB[s.eta]?.length || 0)){
    s.missioneAttuale = DB[s.eta][s.missioniFatte];
    s.passo = 0;
    s.fsm = "GIOCO";
    disegna();
  }else{
    s.fsm = "INIZIO";
    disegna();
    setTimeout(()=> speak("Perfetto. Per oggi le missioni sono finite. A domani!"), 120);
  }
}

window.successivo = () => {
  const m = s.missioneAttuale;
  if(!m) return;

  if(s.passo < m.p.length - 1){
    s.passo++;
    disegna();
    setTimeout(()=> speak(m.p[s.passo]), 120);
  }else{
    // missione completata: overlay + voce + salva in diario
    document.getElementById("overlay-success").style.display = "flex";
    setTimeout(()=> speak("Missione completata! Bravissimo!"), 80);

    // salva diario
    s.diario.push({ t: m.t, date: todayIT(), eta: s.eta });

    setTimeout(()=>{
      document.getElementById("overlay-success").style.display = "none";
      s.missioniFatte++;
      proproxima();
    }, 2800);
  }
};

window.esciGioco = () => {
  s.fsm = "INIZIO";
  disegna();
};

window.apriDiario = () => {
  stopSpeech();
  document.getElementById("diario-modal").style.display = "flex";
  renderDiario();
  setTimeout(()=> speak("Ecco il diario. Qui trovi le missioni che hai completato."), 120);
};

window.chiudiDiario = () => {
  stopSpeech();
  document.getElementById("diario-modal").style.display = "none";
};

/* Safety: se cambi tab/app, stop voce */
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden) stopSpeech();
});

/* Start */
disegna();

})();</script>
</body>
</html>